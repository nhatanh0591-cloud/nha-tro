<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Nh√† Tr·ªç - Web Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: #f0f2f5;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        .sidebar-item.active {
            background-color: #e6f7ff;
            color: #1890ff;
            border-right: 3px solid #1890ff;
            font-weight: 600;
        }
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-approved { background-color: #d4edda; color: #155724; }
        .status-pending { background-color: #fff3cd; color: #856404; }
        .dropdown-arrow {
            transition: transform 0.3s ease;
        }
        .dropdown-content {
            display: none;
        }
        .dropdown-content.show {
            display: block !important;
        }
        .dropdown-arrow.rotated {
            transform: rotate(180deg);
        }
        
        /* Date input styles */
        input[type="date"] {
            cursor: pointer;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
        }
        
        /* Print styles */
        @media print {
            body * {
                visibility: hidden;
            }
            #bill-detail-modal, #bill-detail-printable, #bill-detail-printable * {
                visibility: visible;
            }
            #bill-detail-modal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                overflow: visible;
                box-shadow: none;
                border: none;
            }
            .modal-backdrop {
                background-color: transparent !important;
            }
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-slate-100">

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-white shadow-md flex-shrink-0">
            <div class="p-4 text-center bg-blue-600 text-white text-xl font-bold">
                QU·∫¢N L√ù NH√Ä TR·ªå
            </div>
            <nav class="mt-4">
                <a href="#" class="block py-3 px-4 text-gray-700 sidebar-item">üìä B·∫£ng tin</a>
                <div class="dropdown-menu">
                    <button class="dropdown-toggle w-full text-left py-3 px-4 text-gray-700 sidebar-item flex justify-between items-center">
                        <span>üìã Danh m·ª•c d·ªØ li·ªáu</span>
                        <span class="dropdown-arrow text-xs">‚ñº</span>
                    </button>
                    <div class="dropdown-content ml-4 hidden">
                        <a href="#" class="block py-2 px-4 text-gray-600 hover:bg-gray-100" id="buildings-btn">üè¢ T√≤a nh√†</a>
                        <a href="#" class="block py-2 px-4 text-gray-600 hover:bg-gray-100" id="services-btn">üí∞ Ph√≠ d·ªãch v·ª•</a>
                    </div>
                </div>
                <div class="dropdown-menu">
                    <button class="dropdown-toggle w-full text-left py-3 px-4 text-gray-700 sidebar-item flex justify-between items-center">
                        <span>üë• Kh√°ch h√†ng</span>
                        <span class="dropdown-arrow text-xs">‚ñº</span>
                    </button>
                    <div class="dropdown-content ml-4 hidden">
                        <a href="#" class="block py-2 px-4 text-gray-600 hover:bg-gray-100" id="contracts-btn">üìã H·ª£p ƒë·ªìng thu√™</a>
                        <a href="#" class="block py-2 px-4 text-gray-600 hover:bg-gray-100" id="customers-btn">üë§ Kh√°ch</a>
                    </div>
                </div>
                <div class="dropdown-menu">
                    <button class="dropdown-toggle w-full text-left py-3 px-4 text-gray-700 sidebar-item flex justify-between items-center active">
                        <span>üí∞ T√†i ch√≠nh</span>
                        <span class="dropdown-arrow text-xs">‚ñº</span>
                    </button>
                    <div class="dropdown-content ml-4 hidden">
                        <a href="#" class="block py-2 px-4 text-gray-600 hover:bg-gray-100" id="bills-btn">üìÑ H√≥a ƒë∆°n</a>
                        <a href="#" class="block py-2 px-4 text-gray-600 hover:bg-gray-100" id="finance-btn">üí∏ Thu chi</a>
                    </div>
                </div>
                <a href="#" class="block py-3 px-4 text-gray-700 sidebar-item">üìä Ghi chi s·ªë</a>
                <a href="#" class="block py-3 px-4 text-gray-700 sidebar-item">üìà B√°o c√°o</a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white shadow-sm p-4 flex justify-between items-center">
                 <h1 class="text-xl font-semibold text-gray-800" id="main-header-title">Danh s√°ch H√≥a ƒë∆°n</h1>
                 <div class="user-info flex items-center gap-3">
                     <span class="font-medium">ƒê·∫∑ng Nh·∫≠t Anh</span>
                     <img src="https://placehold.co/40x40/E2E8F0/4A5568?text=A" class="rounded-full" alt="Avatar">
                 </div>
            </header>

            <div class="flex-1 p-6 overflow-y-auto">
                <!-- Buildings Section -->
                <div id="buildings-section" class="hidden">
                    <div class="bg-white rounded-lg shadow overflow-hidden mb-6">
                        <div class="p-4 border-b flex justify-between items-center">
                            <h2 class="text-lg font-semibold">Qu·∫£n l√Ω T√≤a nh√†</h2>
                            <button id="add-building-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                                + Th√™m T√≤a nh√†
                            </button>
                        </div>
                        <div class="p-4">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b text-left text-gray-600 text-sm font-medium">
                                        <th class="py-3 px-4">M√£</th>
                                        <th class="py-3 px-4">ƒê·ªãa ch·ªâ</th>
                                        <th class="py-3 px-4">S·ªë ph√≤ng</th>
                                        <th class="py-3 px-4">Danh s√°ch ph√≤ng</th>
                                        <th class="py-3 px-4">Thao t√°c</th>
                                    </tr>
                                </thead>
                                <tbody id="buildings-list">
                                    <!-- Buildings will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Services Section -->
                <div id="services-section" class="hidden">
                    <div class="bg-white rounded-lg shadow overflow-hidden mb-6">
                        <div class="p-4 border-b flex justify-between items-center">
                            <h2 class="text-lg font-semibold">Qu·∫£n l√Ω Ph√≠ d·ªãch v·ª•</h2>
                            <button id="add-service-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                                + Th√™m Ph√≠ d·ªãch v·ª•
                            </button>
                        </div>
                        <div class="p-4">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b text-left text-gray-600 text-sm font-medium">
                                        <th class="py-3 px-4">T√™n d·ªãch v·ª•</th>
                                        <th class="py-3 px-4">ƒê∆°n gi√°</th>
                                        <th class="py-3 px-4">ƒê∆°n v·ªã</th>
                                        <th class="py-3 px-4">Thao t√°c</th>
                                    </tr>
                                </thead>
                                <tbody id="services-list">
                                    <!-- Services will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Contracts Section -->
                <div id="contracts-section" class="hidden">
                    <!-- Contract Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div class="bg-white p-5 rounded-lg shadow">
                            <h3 class="text-sm font-medium text-gray-500">T·ªïng H·ª£p ƒë·ªìng</h3>
                            <p class="text-2xl font-bold text-blue-600" id="total-contracts">0</p>
                        </div>
                        <div class="bg-white p-5 rounded-lg shadow">
                            <h3 class="text-sm font-medium text-gray-500">ƒêang Thu√™</h3>
                            <p class="text-2xl font-bold text-green-600" id="active-contracts">0</p>
                        </div>
                        <div class="bg-white p-5 rounded-lg shadow">
                            <h3 class="text-sm font-medium text-gray-500">S·∫Øp H·∫øt H·∫°n</h3>
                            <p class="text-2xl font-bold text-yellow-600" id="expiring-contracts">0</p>
                        </div>
                        <div class="bg-white p-5 rounded-lg shadow">
                            <h3 class="text-sm font-medium text-gray-500">Qu√° H·∫°n</h3>
                            <p class="text-2xl font-bold text-red-600" id="expired-contracts">0</p>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow overflow-hidden mb-6">
                        <div class="p-4 border-b flex justify-between items-center">
                            <h2 class="text-lg font-semibold">Qu·∫£n l√Ω H·ª£p ƒë·ªìng thu√™</h2>
                            <button id="add-contract-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                                + Th√™m H·ª£p ƒë·ªìng
                            </button>
                        </div>
                        
                        <!-- Filters -->
                        <div class="p-4 border-b bg-gray-50">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">T√≤a nh√†</label>
                                    <select id="filter-building" class="w-full p-2 border rounded-lg">
                                        <option value="">T·∫•t c·∫£ t√≤a nh√†</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Ph√≤ng</label>
                                    <select id="filter-room" class="w-full p-2 border rounded-lg">
                                        <option value="">T·∫•t c·∫£ ph√≤ng</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Tr·∫°ng th√°i</label>
                                    <select id="filter-status" class="w-full p-2 border rounded-lg">
                                        <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                                        <option value="active">ƒêang thu√™</option>
                                        <option value="expiring">S·∫Øp h·∫øt h·∫°n</option>
                                        <option value="expired">Qu√° h·∫°n</option>
                                        <option value="terminated">ƒê√£ thanh l√Ω</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="p-4 overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b text-left text-gray-600 text-sm font-medium">
                                        <th class="py-3 px-4">M√£ h·ª£p ƒë·ªìng</th>
                                        <th class="py-3 px-4">Kh√°ch h√†ng</th>
                                        <th class="py-3 px-4">B·∫Øt ƒë·∫ßu</th>
                                        <th class="py-3 px-4">K·∫øt th√∫c</th>
                                        <th class="py-3 px-4">Tr·∫°ng th√°i</th>
                                        <th class="py-3 px-4">Gi√° thu√™</th>
                                        <th class="py-3 px-4">Thao t√°c</th>
                                    </tr>
                                </thead>
                                <tbody id="contracts-list">
                                    <!-- Contracts will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Customers Section -->
                <div id="customers-section" class="hidden">
                    <div class="bg-white rounded-lg shadow overflow-hidden mb-6">
                        <div class="p-4 border-b flex justify-between items-center">
                            <h2 class="text-lg font-semibold">Qu·∫£n l√Ω Kh√°ch h√†ng</h2>
                            <button id="add-customer-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                                + Th√™m Kh√°ch h√†ng
                            </button>
                        </div>
                        <div class="p-4">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b text-left text-gray-600 text-sm font-medium">
                                        <th class="py-3 px-4">H·ªç t√™n</th>
                                        <th class="py-3 px-4">S·ªë ƒëi·ªán tho·∫°i</th>
                                        <th class="py-3 px-4">Thao t√°c</th>
                                    </tr>
                                </thead>
                                <tbody id="customers-list">
                                    <!-- Customers will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div id="main-section" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white p-5 rounded-lg shadow">
                        <h3 class="text-sm font-medium text-gray-500">T·ªïng Ph·∫£i Thu</h3>
                        <p class="text-2xl font-bold text-blue-600" id="total-receivable">0</p>
                    </div>
                    <div class="bg-white p-5 rounded-lg shadow">
                        <h3 class="text-sm font-medium text-gray-500">ƒê√£ Thanh To√°n</h3>
                        <p class="text-2xl font-bold text-green-600" id="total-paid">0</p>
                    </div>
                    <div class="bg-white p-5 rounded-lg shadow">
                        <h3 class="text-sm font-medium text-gray-500">C√≤n N·ª£</h3>
                        <p class="text-2xl font-bold text-red-600" id="total-debt">0</p>
                    </div>
                    <div class="bg-white p-5 rounded-lg shadow">
                        <h3 class="text-sm font-medium text-gray-500">S·ªë H√≥a ƒë∆°n</h3>
                        <p class="text-2xl font-bold text-gray-800" id="total-bills-count">0</p>
                    </div>
                </div>

                <!-- Bills Section -->
                <div id="bills-section">
                    <!-- Bill Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="bg-white p-5 rounded-lg shadow">
                            <h3 class="text-sm font-medium text-gray-500">T·ªïng ti·ªÅn</h3>
                            <p class="text-2xl font-bold text-blue-600" id="total-bill-amount">0 VNƒê</p>
                        </div>
                        <div class="bg-white p-5 rounded-lg shadow">
                            <h3 class="text-sm font-medium text-gray-500">ƒê√£ thu</h3>
                            <p class="text-2xl font-bold text-green-600" id="collected-amount">0 VNƒê</p>
                        </div>
                        <div class="bg-white p-5 rounded-lg shadow">
                            <h3 class="text-sm font-medium text-gray-500">Ph·∫£i thu</h3>
                            <p class="text-2xl font-bold text-red-600" id="pending-amount">0 VNƒê</p>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow overflow-hidden mb-6">
                        <div class="p-4 border-b flex justify-between items-center">
                            <h2 class="text-lg font-semibold">Qu·∫£n l√Ω H√≥a ƒë∆°n</h2>
                            <button id="add-bill-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                                + Th√™m H√≥a ƒë∆°n
                            </button>
                        </div>
                        
                        <!-- Filters -->
                        <div class="p-4 border-b bg-gray-50">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">T√≤a nh√†</label>
                                    <select id="filter-bill-building" class="w-full p-2 border rounded-lg">
                                        <option value="">T·∫•t c·∫£ t√≤a nh√†</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Ph√≤ng</label>
                                    <select id="filter-bill-room" class="w-full p-2 border rounded-lg">
                                        <option value="">T·∫•t c·∫£ ph√≤ng</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Th√°ng</label>
                                    <select id="filter-bill-month" class="w-full p-2 border rounded-lg">
                                        <option value="">T·∫•t c·∫£ th√°ng</option>
                                        <option value="1">Th√°ng 1</option>
                                        <option value="2">Th√°ng 2</option>
                                        <option value="3">Th√°ng 3</option>
                                        <option value="4">Th√°ng 4</option>
                                        <option value="5">Th√°ng 5</option>
                                        <option value="6">Th√°ng 6</option>
                                        <option value="7">Th√°ng 7</option>
                                        <option value="8">Th√°ng 8</option>
                                        <option value="9">Th√°ng 9</option>
                                        <option value="10">Th√°ng 10</option>
                                        <option value="11">Th√°ng 11</option>
                                        <option value="12">Th√°ng 12</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Tr·∫°ng th√°i</label>
                                    <select id="filter-bill-status" class="w-full p-2 border rounded-lg">
                                        <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                                        <option value="unpaid">Ch∆∞a thanh to√°n</option>
                                        <option value="paid">ƒê√£ thanh to√°n</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="p-4 overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b text-left text-gray-600 text-sm font-medium">
                                        <th class="py-3 px-4">M√£ h√≥a ƒë∆°n</th>
                                        <th class="py-3 px-4">Kh√°ch h√†ng</th>
                                        <th class="py-3 px-4">K·ª≥ thanh to√°n</th>
                                        <th class="py-3 px-4">Ng√†y l·∫≠p</th>
                                        <th class="py-3 px-4">T·ªïng ti·ªÅn</th>
                                        <th class="py-3 px-4">Tr·∫°ng th√°i</th>
                                        <th class="py-3 px-4">Thao t√°c</th>
                                    </tr>
                                </thead>
                                <tbody id="bills-list">
                                    <!-- Bills will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Building Modal -->
    <div id="building-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg modal-content transform scale-95">
            <div class="p-5 border-b flex justify-between items-center">
                <h3 class="text-lg font-semibold" id="building-modal-title">Th√™m T√≤a nh√†</h3>
                <button id="close-building-modal" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <form id="building-form" class="p-5 space-y-4">
                <input type="hidden" id="building-id">
                <div>
                    <label for="building-code" class="block mb-2 text-sm font-medium">M√£ t√≤a nh√†</label>
                    <input type="text" id="building-code" class="w-full p-2.5 border rounded-lg bg-gray-50" placeholder="V√≠ d·ª•: A1, B2, C3..." required>
                </div>
                <div>
                    <label for="building-address" class="block mb-2 text-sm font-medium">ƒê·ªãa ch·ªâ t√≤a nh√†</label>
                    <input type="text" id="building-address" class="w-full p-2.5 border rounded-lg bg-gray-50" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ t√≤a nh√†" required>
                </div>
                <div>
                    <label for="building-rooms" class="block mb-2 text-sm font-medium">Danh s√°ch ph√≤ng</label>
                    <input type="text" id="building-rooms" class="w-full p-2.5 border rounded-lg bg-gray-50" placeholder="101, 102, 103, 201, 202..." required>
                    <small class="text-gray-500">Nh·∫≠p m√£ s·ªë ph√≤ng, ngƒÉn c√°ch b·∫±ng d·∫•u ph·∫©y</small>
                </div>
                <div class="pt-4 flex justify-end gap-3">
                    <button type="button" id="cancel-building-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">H·ªßy</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700">L∆∞u</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Service Modal -->
    <div id="service-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg modal-content transform scale-95">
            <div class="p-5 border-b flex justify-between items-center">
                <h3 class="text-lg font-semibold" id="service-modal-title">Th√™m Ph√≠ d·ªãch v·ª•</h3>
                <button id="close-service-modal" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <form id="service-form" class="p-5 space-y-4">
                <input type="hidden" id="service-id">
                <div>
                    <label for="service-name" class="block mb-2 text-sm font-medium">T√™n d·ªãch v·ª•</label>
                    <input type="text" id="service-name" class="w-full p-2.5 border rounded-lg bg-gray-50" placeholder="V√≠ d·ª•: Ti·ªÅn ƒëi·ªán" required>
                </div>
                <div>
                    <label for="service-price" class="block mb-2 text-sm font-medium">ƒê∆°n gi√°</label>
                    <input type="text" id="service-price" class="w-full p-2.5 border rounded-lg bg-gray-50 money-input" placeholder="V√≠ d·ª•: 4.000" required>
                </div>
                <div>
                    <label for="service-unit" class="block mb-2 text-sm font-medium">ƒê∆°n v·ªã</label>
                    <input type="text" id="service-unit" class="w-full p-2.5 border rounded-lg bg-gray-50" placeholder="V√≠ d·ª•: Kwh, Ng∆∞·ªùi, Th√°ng..." required>
                </div>
                <div>
                    <label for="service-buildings" class="block mb-2 text-sm font-medium">√Åp d·ª•ng cho t√≤a nh√†</label>
                    <div id="building-checkboxes" class="space-y-2 max-h-40 overflow-y-auto border rounded-lg p-3 bg-gray-50">
                        <!-- Building checkboxes will be populated here -->
                    </div>
                    <small class="text-gray-500">Ch·ªçn c√°c t√≤a nh√† mu·ªën √°p d·ª•ng ph√≠ d·ªãch v·ª• n√†y</small>
                </div>
                <div class="pt-4 flex justify-end gap-3">
                    <button type="button" id="cancel-service-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">H·ªßy</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700">L∆∞u</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Contract Modal -->
    <div id="contract-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl modal-content transform scale-95 max-h-[90vh] overflow-y-auto">
            <div class="p-5 border-b flex justify-between items-center sticky top-0 bg-white">
                <h3 class="text-lg font-semibold" id="contract-modal-title">Th√™m H·ª£p ƒë·ªìng thu√™</h3>
                <button id="close-contract-modal" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <form id="contract-form" class="p-5 space-y-6">
                <input type="hidden" id="contract-id">
                
                <!-- Section 1: General Info -->
                <div class="border rounded-lg p-4">
                    <h4 class="text-md font-semibold mb-4 text-blue-600">1. Th√¥ng tin chung</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="contract-building" class="block mb-2 text-sm font-medium">Ch·ªçn t√≤a nh√†</label>
                            <select id="contract-building" class="w-full p-2.5 border rounded-lg bg-gray-50" required>
                                <option value="">-- Ch·ªçn t√≤a nh√† --</option>
                            </select>
                        </div>
                        <div>
                            <label for="contract-room" class="block mb-2 text-sm font-medium">Ph√≤ng</label>
                            <select id="contract-room" class="w-full p-2.5 border rounded-lg bg-gray-50" required>
                                <option value="">-- Ch·ªçn ph√≤ng --</option>
                            </select>
                        </div>
                        <div>
                            <label for="contract-start-date" class="block mb-2 text-sm font-medium">Ng√†y b·∫Øt ƒë·∫ßu</label>
                            <input type="date" id="contract-start-date" class="w-full p-2.5 border rounded-lg bg-gray-50" required>
                        </div>
                        <div>
                            <label for="contract-end-date" class="block mb-2 text-sm font-medium">Ng√†y k·∫øt th√∫c</label>
                            <input type="date" id="contract-end-date" class="w-full p-2.5 border rounded-lg bg-gray-50" required>
                        </div>
                        <div>
                            <label for="contract-payment-day" class="block mb-2 text-sm font-medium">H·∫°n thanh to√°n (ng√†y trong th√°ng)</label>
                            <input type="number" id="contract-payment-day" class="w-full p-2.5 border rounded-lg bg-gray-50" min="1" max="31" placeholder="V√≠ d·ª•: 3" required>
                        </div>
                    </div>
                </div>

                <!-- Section 2: Customers -->
                <div class="border rounded-lg p-4">
                    <h4 class="text-md font-semibold mb-4 text-blue-600">2. Kh√°ch h√†ng</h4>
                    <div class="relative">
                        <button type="button" id="customer-selector-btn" class="w-full p-3 border rounded-lg bg-gray-50 text-left flex justify-between items-center">
                            <span id="selected-customers-text">Ch·ªçn kh√°ch h√†ng...</span>
                            <span>‚ñº</span>
                        </button>
                        
                        <div id="customer-dropdown" class="absolute top-full left-0 right-0 bg-white border rounded-lg shadow-lg z-10 hidden">
                            <div class="p-3 border-b">
                                <input type="text" id="customer-search" class="w-full p-2 border rounded" placeholder="T√¨m theo t√™n ho·∫∑c s·ªë ƒëi·ªán tho·∫°i...">
                            </div>
                            <div class="p-2 border-b">
                                <button type="button" id="add-customer-from-contract" class="w-full p-2 bg-green-600 text-white rounded text-sm hover:bg-green-700">
                                    + Th√™m kh√°ch h√†ng m·ªõi
                                </button>
                            </div>
                            <div id="customer-options" class="max-h-60 overflow-y-auto">
                                <!-- Customer options will be populated here -->
                            </div>
                        </div>
                    </div>
                    <div id="selected-customers-display" class="mt-3 space-y-2">
                        <!-- Selected customers will be displayed here -->
                    </div>
                </div>

                <!-- Section 3: Rent Price & Deposit -->
                <div class="border rounded-lg p-4">
                    <h4 class="text-md font-semibold mb-4 text-blue-600">3. Gi√° thu√™ & ti·ªÅn c·ªçc</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="contract-rent-price" class="block mb-2 text-sm font-medium">Gi√° thu√™ (VNƒê/th√°ng)</label>
                            <input type="text" id="contract-rent-price" class="w-full p-2.5 border rounded-lg bg-gray-50 money-input" placeholder="V√≠ d·ª•: 3.500.000" required>
                        </div>
                        <div>
                            <label for="contract-deposit" class="block mb-2 text-sm font-medium">Ti·ªÅn c·ªçc (VNƒê)</label>
                            <input type="text" id="contract-deposit" class="w-full p-2.5 border rounded-lg bg-gray-50 money-input" placeholder="V√≠ d·ª•: 7.000.000" required>
                        </div>
                    </div>
                </div>

                <!-- Section 4: Services -->
                <div class="border rounded-lg p-4">
                    <h4 class="text-md font-semibold mb-4 text-blue-600">4. Ph√≠ d·ªãch v·ª•</h4>
                    <div id="contract-services-list" class="space-y-3">
                        <!-- Services will be populated here -->
                    </div>
                </div>

                <div class="pt-4 flex justify-end gap-3">
                    <button type="button" id="cancel-contract-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">H·ªßy</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700">L∆∞u H·ª£p ƒë·ªìng</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Quick Add Customer Modal (from contract) -->
    <div id="quick-customer-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md modal-content transform scale-95">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-semibold">Th√™m kh√°ch h√†ng m·ªõi</h3>
                <button id="close-quick-customer-modal" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <form id="quick-customer-form" class="p-4 space-y-4">
                <div>
                    <label for="quick-customer-name" class="block mb-2 text-sm font-medium">H·ªç t√™n</label>
                    <input type="text" id="quick-customer-name" class="w-full p-2.5 border rounded-lg bg-gray-50" placeholder="Nh·∫≠p h·ªç t√™n kh√°ch h√†ng" required>
                </div>
                <div>
                    <label for="quick-customer-phone" class="block mb-2 text-sm font-medium">S·ªë ƒëi·ªán tho·∫°i</label>
                    <input type="tel" id="quick-customer-phone" class="w-full p-2.5 border rounded-lg bg-gray-50" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" required>
                </div>
                <div class="pt-2 flex justify-end gap-3">
                    <button type="button" id="cancel-quick-customer-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">H·ªßy</button>
                    <button type="submit" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700">Th√™m & Ch·ªçn</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Customer Modal -->
    <div id="customer-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg modal-content transform scale-95">
            <div class="p-5 border-b flex justify-between items-center">
                <h3 class="text-lg font-semibold" id="customer-modal-title">Th√™m Kh√°ch h√†ng</h3>
                <button id="close-customer-modal" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <form id="customer-form" class="p-5 space-y-4">
                <input type="hidden" id="customer-id">
                <div>
                    <label for="customer-name" class="block mb-2 text-sm font-medium">H·ªç t√™n</label>
                    <input type="text" id="customer-name" class="w-full p-2.5 border rounded-lg bg-gray-50" placeholder="Nh·∫≠p h·ªç t√™n kh√°ch h√†ng" required>
                </div>
                <div>
                    <label for="customer-phone" class="block mb-2 text-sm font-medium">S·ªë ƒëi·ªán tho·∫°i</label>
                    <input type="tel" id="customer-phone" class="w-full p-2.5 border rounded-lg bg-gray-50" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" required>
                </div>
                <div class="pt-4 flex justify-end gap-3">
                    <button type="button" id="cancel-customer-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">H·ªßy</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700">L∆∞u</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Bill Modal -->
    <div id="bill-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl modal-content transform scale-95 max-h-screen overflow-y-auto">
            <div class="p-5 border-b flex justify-between items-center">
                <h3 class="text-lg font-semibold" id="bill-modal-title">T·∫°o H√≥a ƒë∆°n Ti·ªÅn Nh√†</h3>
                <button id="close-bill-modal" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <form id="bill-form" class="p-5 space-y-6">
                <input type="hidden" id="bill-id">
                
                <!-- Section 1: General Info -->
                <div class="border rounded-lg p-4 bg-gray-50">
                    <h4 class="text-md font-semibold mb-4 text-blue-600">1. Th√¥ng tin chung</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                            <label for="bill-building" class="block mb-2 text-sm font-medium">T√≤a nh√†</label>
                            <select id="bill-building" class="w-full p-2.5 border rounded-lg bg-white" required>
                                <option value="">-- Ch·ªçn t√≤a nh√† --</option>
                            </select>
                        </div>
                        <div>
                            <label for="bill-room" class="block mb-2 text-sm font-medium">Ph√≤ng</label>
                            <select id="bill-room" class="w-full p-2.5 border rounded-lg bg-white" required>
                                <option value="">-- Ch·ªçn ph√≤ng --</option>
                            </select>
                        </div>
                        <div>
                            <label for="bill-customer" class="block mb-2 text-sm font-medium">Kh√°ch h√†ng</label>
                            <input type="text" id="bill-customer" class="w-full p-2.5 border rounded-lg bg-gray-100" readonly>
                            <input type="hidden" id="bill-customer-id">
                        </div>
                        <div>
                            <label for="bill-period" class="block mb-2 text-sm font-medium">K·ª≥ thanh to√°n</label>
                            <select id="bill-period" class="w-full p-2.5 border rounded-lg bg-white" required>
                                <option value="">-- Ch·ªçn th√°ng --</option>
                                <option value="1">Th√°ng 1</option>
                                <option value="2">Th√°ng 2</option>
                                <option value="3">Th√°ng 3</option>
                                <option value="4">Th√°ng 4</option>
                                <option value="5">Th√°ng 5</option>
                                <option value="6">Th√°ng 6</option>
                                <option value="7">Th√°ng 7</option>
                                <option value="8">Th√°ng 8</option>
                                <option value="9">Th√°ng 9</option>
                                <option value="10">Th√°ng 10</option>
                                <option value="11">Th√°ng 11</option>
                                <option value="12">Th√°ng 12</option>
                            </select>
                        </div>
                        <div>
                            <label for="bill-date" class="block mb-2 text-sm font-medium">Ng√†y l·∫≠p H√≥a ƒë∆°n</label>
                            <input type="date" id="bill-date" class="w-full p-2.5 border rounded-lg bg-white" required>
                        </div>
                    </div>
                </div>

                <!-- Section 2: Services & Fees -->
                <div class="border rounded-lg p-4 bg-gray-50">
                    <h4 class="text-md font-semibold mb-4 text-blue-600">2. D·ªãch v·ª• & ph√≠</h4>
                    
                    <!-- Services Table -->
                    <div class="overflow-x-auto mb-4">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b text-left text-gray-600">
                                    <th class="py-2 px-3">D·ªãch v·ª•</th>
                                    <th class="py-2 px-3">ƒê∆°n gi√°</th>
                                    <th class="py-2 px-3">T·ª´ ng√†y</th>
                                    <th class="py-2 px-3">ƒê·∫øn ng√†y</th>
                                    <th class="py-2 px-3">S·ªë l∆∞·ª£ng</th>
                                    <th class="py-2 px-3">Th√†nh ti·ªÅn</th>
                                </tr>
                            </thead>
                            <tbody id="bill-services-list">
                                <!-- Services will be populated here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Total Amount -->
                    <div class="flex justify-end">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <div class="text-sm text-gray-600">T·ªïng th√†nh ti·ªÅn:</div>
                            <div class="text-xl font-bold text-blue-600" id="bill-total-amount">0 VNƒê</div>
                        </div>
                    </div>
                </div>

                <div class="pt-4 flex justify-end gap-3">
                    <button type="button" id="cancel-bill-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">H·ªßy</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700">L∆∞u H√≥a ƒë∆°n</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bill Detail Modal - RE-DESIGNED -->
    <div id="bill-detail-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl modal-content transform scale-95 max-h-[95vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center no-print">
                <h3 class="text-lg font-semibold">Chi ti·∫øt H√≥a ƒë∆°n</h3>
                <div class="flex items-center gap-2">
                     <button id="print-bill-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 text-sm">üñ®Ô∏è In h√≥a ƒë∆°n</button>
                    <button id="close-bill-detail-modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                </div>
            </div>
            <div class="p-8 overflow-y-auto" id="bill-detail-printable">
                <!-- Bill Container with Border -->
                <div class="border-2 border-gray-800 p-6">
                    <!-- Bill Header -->
                    <div class="text-center mb-8">
                        <h2 id="bill-detail-title" class="text-3xl font-bold">H√≥a ƒê∆°n Ti·ªÅn Nh√†</h2>
                    </div>

                <!-- Customer and Bill Info -->
                <div class="mb-8 p-4 bg-gray-50 rounded-lg">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p><span class="text-gray-600">Ph√≤ng:</span> <span id="bill-detail-room" class="font-bold ml-2"></span></p>
                            <p><span class="text-gray-600">Kh√°ch h√†ng:</span> <span id="bill-detail-customer-name" class="font-bold ml-2"></span></p>
                            <p><span class="text-gray-600">ƒê·ªãa ch·ªâ:</span> <span id="bill-detail-address" class="font-bold ml-2"></span></p>
                        </div>
                        <div class="text-right">
                            <p><span class="text-gray-600">S·ªë h√≥a ƒë∆°n:</span> <span id="bill-detail-number" class="font-bold ml-2"></span></p>
                            <p><span class="text-gray-600">Ng√†y:</span> <span id="bill-detail-date" class="font-bold ml-2"></span></p>
                            <p><span class="text-gray-600">H·∫°n cu·ªëi:</span> <span id="bill-detail-due-date" class="font-bold ml-2"></span></p>
                        </div>
                    </div>
                </div>

                    <!-- Bill Items -->
                    <div class="mb-8">
                        <table class="w-full border-2 border-gray-800">
                            <thead class="bg-green-600 text-white">
                                <tr>
                                    <th class="py-2 px-3 text-left font-semibold border border-gray-800">STT</th>
                                    <th class="py-2 px-3 text-left font-semibold border border-gray-800">N·ªôi dung</th>
                                    <th class="py-2 px-3 text-center font-semibold border border-gray-800">ƒê∆°n gi√° (VNƒê)</th>
                                    <th class="py-2 px-3 text-center font-semibold border border-gray-800">S·ªë l∆∞·ª£ng</th>
                                    <th class="py-2 px-3 text-right font-semibold border border-gray-800">Th√†nh ti·ªÅn</th>
                                </tr>
                            </thead>
                            <tbody id="bill-detail-services-table">
                                <!-- Items will be populated here -->
                            </tbody>
                        </table>
                    </div>                    <!-- Bill Summary -->
                    <div>
                        <div class="flex justify-between items-end">
                            <div class="w-32 h-32">
                               <img id="bill-detail-qr" src="" alt="" class="w-full h-full object-contain"/>
                            </div>
                            <div class="text-right space-y-2">
                             <div class="flex justify-between">
                                <span>T·∫°m t√≠nh:</span>
                                <span id="bill-detail-subtotal" class="font-medium"></span>
                            </div>
                             <div class="flex justify-between">
                                <span>ƒê√£ thanh to√°n:</span>
                                <span id="bill-detail-paid" class="font-medium">0 VNƒê</span>
                            </div>
                            <div class="border-t my-2"></div>
                             <div class="flex justify-between items-center text-base">
                                    <span class="font-bold text-red-600">C√≤n l·∫°i:</span>
                                    <span id="bill-detail-due-amount" class="font-bold text-red-600 ml-4"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Bill Container -->
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-3 px-5 rounded-lg shadow-xl hidden transform translate-y-16 transition-transform duration-300">
        <p id="toast-message"></p>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-[100] flex items-center justify-center hidden">
        <div class="text-white text-xl">ƒêang k·∫øt n·ªëi t·ªõi Firebase...</div>
    </div>

    <!-- Firebase App Logic -->
    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, setDoc, deleteDoc, serverTimestamp, query, where, orderBy } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyA2m1K7pijNC1yirw_t36Rc3HnzCsD8pCs",
            authDomain: "nha-tro-53ca7.firebaseapp.com",
            projectId: "nha-tro-53ca7",
            storageBucket: "nha-tro-53ca7.firebasestorage.app",
            messagingSenderId: "415886594203",
            appId: "1:415886594203:web:f3cda09037973176c9763e",
            measurementId: "G-Y5GSRYP4XC"
        };

        // --- INITIALIZE FIREBASE ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- YOUR BANK INFO FOR VIETQR ---
        const YOUR_BANK_ID = "970416"; // ACB Bank's BIN code. Change to your bank's code.
        const YOUR_ACCOUNT_NO = "113366668888"; // Change to your account number.
        const YOUR_ACCOUNT_NAME = "DANG NHAT ANH"; // Change to your account name.

        // --- FIREBASE CACHE VARIABLES ---
        let buildingsCache = [];
        let servicesCache = [];
        let customersCache = [];
        let contractsCache = [];
        let billsCache = [];
        let tenantsCache = [];

        // --- FIREBASE HELPERS ---
        function getBuildings() {
            return buildingsCache;
        }
        
        function getServices() {
            return servicesCache;
        }
        
        function getCustomers() {
            return customersCache;
        }
        
        function getContracts() {
            return contractsCache;
        }

        function getBills() {
            return billsCache;
        }

        // Utility functions
        function generateId() {
            return Date.now().toString() + Math.random().toString(36).substr(2, 9);
        }

        // Cache variables - ƒë√£ khai b√°o ·ªü tr√™n

        // --- FIREBASE INITIALIZATION ---
        const loadingOverlay = document.getElementById('loading-overlay');
        let isFirebaseReady = false;

        async function initializeFirebase() {
            try {
                loadingOverlay.classList.remove('hidden');
                
                // Sign in anonymously
                await signInAnonymously(auth);
                console.log("Signed in to Firebase successfully");
                
                // Set up real-time listeners
                setupFirebaseListeners();
                
            } catch (error) {
                console.error("Firebase initialization error:", error);
                showToast('L·ªói k·∫øt n·ªëi Firebase: ' + error.message, 'error');
                loadingOverlay.querySelector('div').textContent = 'L·ªói k·∫øt n·ªëi Firebase. Vui l√≤ng refresh trang.';
            }
        }

        function setupFirebaseListeners() {
            const collections = ['buildings', 'services', 'customers', 'contracts', 'bills'];
            let loadedCount = 0;

            collections.forEach(collectionName => {
                const q = query(collection(db, collectionName), orderBy('createdAt', 'desc'));
                
                onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Update cache
                    switch(collectionName) {
                        case 'buildings': buildingsCache = data; break;
                        case 'services': servicesCache = data; break;
                        case 'customers': customersCache = data; break;
                        case 'contracts': contractsCache = data; break;
                        case 'bills': billsCache = data; break;
                    }
                    
                    // Reload UI if page is ready
                    if (isFirebaseReady) {
                        switch(collectionName) {
                            case 'buildings': if (buildingsSection && !buildingsSection.classList.contains('hidden')) loadBuildings(); break;
                            case 'services': if (servicesSection && !servicesSection.classList.contains('hidden')) loadServices(); break;
                            case 'customers': if (customersSection && !customersSection.classList.contains('hidden')) loadCustomers(); break;
                            case 'contracts': if (contractsSection && !contractsSection.classList.contains('hidden')) loadContracts(); break;
                            case 'bills': if (billsSection && !billsSection.classList.contains('hidden')) loadBills(); break;
                        }
                    }
                    
                    // Hide loading when all collections loaded
                    if (++loadedCount >= collections.length && !isFirebaseReady) {
                        isFirebaseReady = true;
                        loadingOverlay.classList.add('hidden');
                        console.log("All Firebase data loaded successfully");
                    }
                }, (error) => {
                    console.error(`Error listening to ${collectionName}:`, error);
                    showToast(`L·ªói t·∫£i d·ªØ li·ªáu ${collectionName}: ${error.message}`, 'error');
                });
            });
        }
        
        // Global function for removing customer
        window.removeCustomer = function(customerId) {
            selectedCustomers = selectedCustomers.filter(id => id !== customerId);
            updateSelectedCustomersDisplay();
            loadCustomerOptions(document.getElementById('customer-search').value);
        }

        // Format number with dots
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }

        // Remove dots from formatted number
        function parseFormattedNumber(str) {
            return parseInt(str.replace(/\./g, '')) || 0;
        }

        // Format date from YYYY-MM-DD to DD-MM-YYYY
        function formatDateDisplay(dateStr) {
            if (!dateStr) return '';
            const [year, month, day] = dateStr.split('-');
            return `${day}/${month}/${year}`;
        }

        // Format money input
        function formatMoneyInput(input) {
            let value = input.value.replace(/\./g, '');
            if (value && !isNaN(value)) {
                input.value = formatNumber(value);
            }
        }

        // --- DOM ELEMENTS ---
        const mainHeaderTitle = document.getElementById('main-header-title');
        const buildingModal = document.getElementById('building-modal');
        const closeBuildingModalBtn = document.getElementById('close-building-modal');
        const cancelBuildingBtn = document.getElementById('cancel-building-btn');
        const addBuildingBtn = document.getElementById('add-building-btn');
        const buildingForm = document.getElementById('building-form');
        const buildingModalTitle = document.getElementById('building-modal-title');
        const buildingsBtn = document.getElementById('buildings-btn');
        const buildingsSection = document.getElementById('buildings-section');
        const servicesSection = document.getElementById('services-section');
        const contractsSection = document.getElementById('contracts-section');
        const customersSection = document.getElementById('customers-section');
        const mainSection = document.getElementById('main-section');
        const billsSection = document.getElementById('bills-section');

        const serviceModal = document.getElementById('service-modal');
        const closeServiceModalBtn = document.getElementById('close-service-modal');
        const cancelServiceBtn = document.getElementById('cancel-service-btn');
        const addServiceBtn = document.getElementById('add-service-btn');
        const serviceForm = document.getElementById('service-form');
        const serviceModalTitle = document.getElementById('service-modal-title');
        const servicesBtn = document.getElementById('services-btn');

        const customerModal = document.getElementById('customer-modal');
        const closeCustomerModalBtn = document.getElementById('close-customer-modal');
        const cancelCustomerBtn = document.getElementById('cancel-customer-btn');
        const addCustomerBtn = document.getElementById('add-customer-btn');
        const customerForm = document.getElementById('customer-form');
        const customerModalTitle = document.getElementById('customer-modal-title');
        const customersBtn = document.getElementById('customers-btn');

        const contractModal = document.getElementById('contract-modal');
        const closeContractModalBtn = document.getElementById('close-contract-modal');
        const cancelContractBtn = document.getElementById('cancel-contract-btn');
        const addContractBtn = document.getElementById('add-contract-btn');
        const contractForm = document.getElementById('contract-form');
        const contractModalTitle = document.getElementById('contract-modal-title');
        const contractsBtn = document.getElementById('contracts-btn');
        
        // Contract filter elements
        const filterBuilding = document.getElementById('filter-building');
        const filterRoom = document.getElementById('filter-room');
        const filterStatus = document.getElementById('filter-status');
        
        // Bill filter elements
        const filterBillBuilding = document.getElementById('filter-bill-building');
        const filterBillRoom = document.getElementById('filter-bill-room');
        const filterBillMonth = document.getElementById('filter-bill-month');
        const filterBillStatus = document.getElementById('filter-bill-status');

        const quickCustomerModal = document.getElementById('quick-customer-modal');
        const closeQuickCustomerModalBtn = document.getElementById('close-quick-customer-modal');
        const cancelQuickCustomerBtn = document.getElementById('cancel-quick-customer-btn');
        const addCustomerFromContractBtn = document.getElementById('add-customer-from-contract');
        const quickCustomerForm = document.getElementById('quick-customer-form');

        const billModal = document.getElementById('bill-modal');
        const closeBillModalBtn = document.getElementById('close-bill-modal');
        const cancelBillBtn = document.getElementById('cancel-bill-btn');
        const addBillBtn = document.getElementById('add-bill-btn');
        const billForm = document.getElementById('bill-form');
        const billModalTitle = document.getElementById('bill-modal-title');
        const billsBtn = document.getElementById('bills-btn');

        const billDetailModal = document.getElementById('bill-detail-modal');
        const closeBillDetailModalBtn = document.getElementById('close-bill-detail-modal');
        const printBillBtn = document.getElementById('print-bill-btn');
        
        // --- MODAL CONTROLS ---
        const openModal = (modalEl) => {
            modalEl.classList.remove('hidden');
            setTimeout(() => {
                modalEl.classList.remove('opacity-0');
                modalEl.querySelector('.modal-content').classList.remove('scale-95');
            }, 10);
        };
        const closeModal = (modalEl) => {
            modalEl.classList.add('opacity-0');
            modalEl.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => modalEl.classList.add('hidden'), 300);
        };

        addBillBtn.addEventListener('click', () => {
            billModalTitle.textContent = "T·∫°o H√≥a ƒë∆°n Ti·ªÅn Nh√†";
            billForm.reset();
            document.getElementById('bill-id').value = '';
            document.getElementById('bill-date').value = new Date().toISOString().split('T')[0];
            loadBillBuildings();
            clearBillServices();
            openModal(billModal);
        });
        
        closeBillModalBtn.addEventListener('click', () => closeModal(billModal));
        cancelBillBtn.addEventListener('click', () => closeModal(billModal));

        // Bill detail modal event handlers
        closeBillDetailModalBtn.addEventListener('click', () => closeModal(billDetailModal));
        printBillBtn.addEventListener('click', () => window.print());

        // Bill form event handlers
        document.getElementById('bill-building').addEventListener('change', function() {
            const buildingId = this.value;
            loadBillRooms(buildingId);
            document.getElementById('bill-customer').value = '';
            document.getElementById('bill-customer-id').value = '';
            clearBillServices();
        });

        document.getElementById('bill-room').addEventListener('change', function() {
            const buildingId = document.getElementById('bill-building').value;
            const room = this.value;
            if (buildingId && room) {
                loadBillCustomer(buildingId, room);
            }
        });
        
        document.getElementById('bill-period').addEventListener('change', function() {
            const buildingId = document.getElementById('bill-building').value;
            const room = document.getElementById('bill-room').value;
            if (buildingId && room) {
                loadBillCustomer(buildingId, room);
            }
        });


        // Service input change handlers
        document.addEventListener('input', function(e) {
            // Handle electric reading changes
            if (e.target.classList.contains('electric-new-reading')) {
                const serviceRow = e.target.closest('tr');
                const oldReading = parseInt(serviceRow.querySelector('.electric-old-reading').value) || 0;
                const newReading = parseInt(e.target.value) || 0;
                const price = parseFloat(e.target.dataset.price);
                const usage = Math.max(0, newReading - oldReading);
                const total = usage * price;
                serviceRow.querySelector('.service-total').textContent = new Intl.NumberFormat('vi-VN').format(total) + ' VNƒê';
                calculateBillTotal();
            }
            
            // Handle service quantity changes
            if (e.target.classList.contains('service-quantity')) {
                const serviceRow = e.target.closest('tr');
                const quantity = parseInt(e.target.value) || 0;
                const price = parseFloat(e.target.dataset.price);
                
                // Get date inputs
                const fromDateInput = serviceRow.querySelector('input[type="date"]:first-of-type');
                const toDateInput = serviceRow.querySelector('input[type="date"]:last-of-type');
                
                if (fromDateInput && toDateInput && fromDateInput.value && toDateInput.value) {
                    const fromDate = new Date(fromDateInput.value);
                    const toDate = new Date(toDateInput.value);
                    const days = Math.max(1, Math.ceil((toDate.getTime() - fromDate.getTime()) / (1000 * 60 * 60 * 24)) + 1);
                    
                    const year = fromDate.getFullYear();
                    const month = fromDate.getMonth();
                    const totalDaysInMonth = new Date(year, month + 1, 0).getDate();
                    
                    const total = (price * quantity / totalDaysInMonth) * days;
                    serviceRow.querySelector('.service-total').textContent = new Intl.NumberFormat('vi-VN').format(Math.round(total)) + ' VNƒê';
                } else {
                    const total = price * quantity;
                    serviceRow.querySelector('.service-total').textContent = new Intl.NumberFormat('vi-VN').format(total) + ' VNƒê';
                }
                calculateBillTotal();
            }
            
            // Handle date changes
            if (e.target.type === 'date') {
                const serviceRow = e.target.closest('tr');
                if (!serviceRow) return;

                const serviceName = serviceRow.querySelector('td:first-child').textContent.trim();
                const dateInputs = serviceRow.querySelectorAll('input[type="date"]');
                
                if (dateInputs.length >= 2 && dateInputs[0].value && dateInputs[1].value) {
                    const fromDate = new Date(dateInputs[0].value);
                    const toDate = new Date(dateInputs[1].value);

                    if (isNaN(fromDate) || isNaN(toDate) || fromDate > toDate) {
                        calculateBillTotal();
                        return; // Invalid date range, do nothing
                    }

                    const days = Math.max(1, Math.ceil((toDate.getTime() - fromDate.getTime()) / (1000 * 60 * 60 * 24)) + 1);
                    
                    const year = fromDate.getFullYear();
                    const month = fromDate.getMonth();
                    const totalDaysInMonth = new Date(year, month + 1, 0).getDate();
                    
                    if (serviceName === 'Ti·ªÅn nh√†') {
                        const daysSpan = serviceRow.querySelector('td:nth-child(5)');
                        if (daysSpan) daysSpan.textContent = `${days} ng√†y`;
                        
                        const buildingId = document.getElementById('bill-building').value;
                        const room = document.getElementById('bill-room').value;
                        const contract = getContracts().find(c => c.buildingId === buildingId && c.room === room && getContractStatus(c) === 'active');
                        
                        if (contract) {
                            const total = (contract.rentPrice / totalDaysInMonth) * days;
                            serviceRow.querySelector('.service-total').textContent = new Intl.NumberFormat('vi-VN').format(Math.round(total)) + ' VNƒê';
                        }
                    } else {
                        const quantityInput = serviceRow.querySelector('.service-quantity');
                        if (quantityInput) {
                            const quantity = parseInt(quantityInput.value) || 0;
                            const price = parseFloat(quantityInput.dataset.price);
                            const total = (price * quantity / totalDaysInMonth) * days;
                            serviceRow.querySelector('.service-total').textContent = new Intl.NumberFormat('vi-VN').format(Math.round(total)) + ' VNƒê';
                        }
                    }
                    
                    calculateBillTotal();
                }
            }
        });

        function loadTenants() {
            tenantsCache = getCustomers();
        }

        // --- BILL FORM SUBMIT - KH√îI PH·ª§C LOGIC T·ª™ index1.html ---
        billForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const billId = document.getElementById('bill-id').value;
            const buildingId = document.getElementById('bill-building').value;
            const room = document.getElementById('bill-room').value;
            const customerId = document.getElementById('bill-customer-id').value;
            const period = document.getElementById('bill-period').value;
            const billDate = document.getElementById('bill-date').value;
            
            if (!buildingId || !room || !customerId || !period || !billDate) {
                showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'error');
                return;
            }
            
            const totalText = document.getElementById('bill-total-amount').textContent;
            const totalAmount = parseInt(totalText.replace(/[^\d]/g, '')) || 0;
            
            if (totalAmount <= 0) {
                showToast('T·ªïng ti·ªÅn ph·∫£i l·ªõn h∆°n 0!', 'error');
                return;
            }
            
            const services = [];
            document.querySelectorAll('#bill-services-list tr').forEach(row => {
                const serviceName = row.querySelector('td:first-child').textContent.trim();
                const totalText = row.querySelector('.service-total').textContent;
                const amount = parseInt(totalText.replace(/[^\d]/g, '')) || 0;
                const dateInputs = row.querySelectorAll('input[type="date"]');
                const fromDate = dateInputs.length > 0 ? dateInputs[0].value : null;
                const toDate = dateInputs.length > 1 ? dateInputs[1].value : null;
                const electricNewInput = row.querySelector('.electric-new-reading');
                const serviceQuantityInput = row.querySelector('.service-quantity');

                let serviceDetail = { serviceName, amount, fromDate, toDate };

                if (serviceName === 'Ti·ªÅn nh√†') {
                    const contract = contractsCache.find(c => c.buildingId === buildingId && c.room === room && getContractStatus(c) === 'active');
                    serviceDetail.type = 'rent';
                    serviceDetail.unitPrice = contract ? contract.rentPrice : 0;
                    serviceDetail.unit = 'th√°ng';
                    const daysSpan = row.querySelector('td:nth-child(5)');
                    serviceDetail.quantityDisplay = daysSpan ? daysSpan.textContent.trim() : '1';
                } else if (electricNewInput) {
                    serviceDetail.type = 'electric';
                    serviceDetail.serviceId = electricNewInput.dataset.serviceId;
                    serviceDetail.unitPrice = parseFloat(electricNewInput.dataset.price);
                    serviceDetail.oldReading = parseInt(row.querySelector('.electric-old-reading').value) || 0;
                    serviceDetail.newReading = parseInt(electricNewInput.value) || 0;
                    serviceDetail.quantity = Math.max(0, serviceDetail.newReading - serviceDetail.oldReading);
                } else if (serviceQuantityInput) {
                    serviceDetail.type = 'service';
                    serviceDetail.serviceId = serviceQuantityInput.dataset.serviceId;
                    serviceDetail.unitPrice = parseFloat(serviceQuantityInput.dataset.price);
                    serviceDetail.quantity = parseInt(serviceQuantityInput.value) || 0;
                }
                
                if(serviceDetail.serviceId) {
                    const serviceDef = servicesCache.find(s => s.id === serviceDetail.serviceId);
                    if(serviceDef) serviceDetail.unit = serviceDef.unit;
                }
                services.push(serviceDetail);
            });
            
            // ===== KH√îI PH·ª§C LOGIC CH√çNH T·ª™ index1.html =====
            const bills = getBills();
            
            if (billId) {
                const billIndex = bills.findIndex(b => b.id === billId);
                if (billIndex !== -1) {
                    const updatedBill = {
                        ...bills[billIndex],
                        buildingId, room, customerId, period, billDate,
                        services,
                        totalAmount,
                        updatedAt: new Date().toISOString()
                    };
                    delete updatedBill.rentInfo; // remove legacy property
                    bills[billIndex] = updatedBill;
                    showToast('C·∫≠p nh·∫≠t H√≥a ƒë∆°n th√†nh c√¥ng!');
                    
                    // Update Firebase
                    try {
                        await setDoc(doc(db, 'bills', billId), {
                            ...updatedBill,
                            updatedAt: serverTimestamp()
                        });
                    } catch (error) {
                        console.error('Error updating Firebase:', error);
                    }
                }
            } else {
                const newBill = {
                    id: generateId(), 
                    buildingId, 
                    room, 
                    customerId, 
                    period, 
                    billDate,
                    services, 
                    totalAmount,
                    status: 'unpaid',
                    createdAt: new Date().toISOString()
                };
                bills.push(newBill);
                showToast('T·∫°o H√≥a ƒë∆°n th√†nh c√¥ng!');
                
                // Save to Firebase
                try {
                    await setDoc(doc(db, 'bills', newBill.id), {
                        ...newBill,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    });
                } catch (error) {
                    console.error('Error saving to Firebase:', error);
                }
            }
            
            // Update local cache and refresh UI
            billsCache = bills;
            loadBills();
            closeModal(billModal);
        });

        // --- UTILITY ---
        function showToast(message, type = 'success') {
            const toastEl = document.getElementById('toast');
            const toastMsg = document.getElementById('toast-message');
            toastMsg.textContent = message;
            toastEl.classList.remove('hidden', 'bg-green-500', 'bg-red-500', 'translate-y-16');
            toastEl.classList.add(type === 'success' ? 'bg-green-500' : 'bg-red-500');

            setTimeout(() => {
                toastEl.classList.add('translate-y-16');
                setTimeout(() => toastEl.classList.add('hidden'), 300);
            }, 3000);
        }
        
        // --- SECTION SWITCHING ---
        function showSection(sectionName) {
            const sections = {
                'buildings': { element: buildingsSection, title: 'Qu·∫£n l√Ω T√≤a nh√†', loader: loadBuildings },
                'services': { element: servicesSection, title: 'Qu·∫£n l√Ω Ph√≠ d·ªãch v·ª•', loader: loadServices },
                'contracts': { element: contractsSection, title: 'Qu·∫£n l√Ω H·ª£p ƒë·ªìng', loader: loadContracts },
                'customers': { element: customersSection, title: 'Qu·∫£n l√Ω Kh√°ch h√†ng', loader: loadCustomers },
                'bills': { element: billsSection, title: 'Danh s√°ch H√≥a ƒë∆°n', loader: loadBills },
                'main': { element: mainSection, title: 'B·∫£ng tin', loader: () => {} }
            };

            Object.values(sections).forEach(sec => sec.element.classList.add('hidden'));

            const selected = sections[sectionName] || sections['bills'];
            selected.element.classList.remove('hidden');
            mainHeaderTitle.textContent = selected.title;
            selected.loader();
        }

        // --- BUILDINGS MANAGEMENT ---
        function loadBuildings() {
            const buildings = getBuildings();
            const listEl = document.getElementById('buildings-list');
            listEl.innerHTML = '';
            
            if (buildings.length === 0) {
                listEl.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-500">Ch∆∞a c√≥ t√≤a nh√† n√†o.</td></tr>';
                return;
            }
            
            buildings.forEach(building => {
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="py-4 px-4 font-bold text-blue-600">${building.code || 'N/A'}</td>
                    <td class="py-4 px-4 font-medium">${building.address}</td>
                    <td class="py-4 px-4">${building.rooms.length} ph√≤ng</td>
                    <td class="py-4 px-4">
                        <div class="flex flex-wrap gap-1">
                            ${building.rooms.map(room => `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">${room}</span>`).join('')}
                        </div>
                    </td>
                    <td class="py-4 px-4 flex gap-3">
                        <button data-id="${building.id}" class="edit-building-btn text-sm font-medium text-blue-600">S·ª≠a</button>
                        <button data-id="${building.id}" class="delete-building-btn text-sm font-medium text-red-600">X√≥a</button>
                    </td>
                `;
                listEl.appendChild(tr);
            });
        }

        // --- SERVICES MANAGEMENT ---
        function loadServices() {
            const services = getServices();
            const listEl = document.getElementById('services-list');
            listEl.innerHTML = '';
            
            if (services.length === 0) {
                listEl.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-gray-500">Ch∆∞a c√≥ ph√≠ d·ªãch v·ª• n√†o.</td></tr>';
                return;
            }
            
            const buildings = getBuildings();
            
            services.forEach(service => {
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-gray-50';
                
                tr.innerHTML = `
                    <td class="py-4 px-4 font-medium">${service.name}</td>
                    <td class="py-4 px-4">${new Intl.NumberFormat('vi-VN').format(service.price)}</td>
                    <td class="py-4 px-4">${service.unit}</td>
                    <td class="py-4 px-4 flex gap-3">
                        <button data-id="${service.id}" class="edit-service-btn text-sm font-medium text-blue-600">S·ª≠a</button>
                        <button data-id="${service.id}" class="delete-service-btn text-sm font-medium text-red-600">X√≥a</button>
                    </td>
                `;
                listEl.appendChild(tr);
            });
        }

        // --- CUSTOMERS MANAGEMENT ---
        function loadCustomers() {
            const customers = getCustomers();
            const listEl = document.getElementById('customers-list');
            listEl.innerHTML = '';
            
            if (customers.length === 0) {
                listEl.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-gray-500">Ch∆∞a c√≥ kh√°ch h√†ng n√†o.</td></tr>';
                return;
            }
            
            customers.forEach(customer => {
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="py-4 px-4 font-medium">${customer.name}</td>
                    <td class="py-4 px-4">${customer.phone}</td>
                    <td class="py-4 px-4 flex gap-3">
                        <button data-id="${customer.id}" class="edit-customer-btn text-sm font-medium text-blue-600">S·ª≠a</button>
                        <button data-id="${customer.id}" class="delete-customer-btn text-sm font-medium text-red-600">X√≥a</button>
                    </td>
                `;
                listEl.appendChild(tr);
            });
        }

        // --- CONTRACTS MANAGEMENT ---
        function loadContracts() {
            contractsCache = getContracts();
            contractsCache.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            renderContracts(contractsCache);
            updateContractStats();
            loadFilterOptions();
        }
        
        function getContractStatus(contract) {
            if (contract.status === 'terminated') return 'terminated';
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const endDate = new Date(contract.endDate);
            endDate.setHours(0, 0, 0, 0);
            const diffTime = endDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) return 'expired'; // Qu√° h·∫°n
            if (diffDays <= 30) return 'expiring'; // S·∫Øp h·∫øt h·∫°n (30 ng√†y)
            return 'active'; // ƒêang thu√™
        }
        
        function getStatusInfo(status) {
            switch (status) {
                case 'active':
                    return { text: 'ƒêang thu√™', className: 'bg-green-100 text-green-800' };
                case 'expiring':
                    return { text: 'S·∫Øp h·∫øt h·∫°n', className: 'bg-yellow-100 text-yellow-800' };
                case 'expired':
                    return { text: 'Qu√° h·∫°n', className: 'bg-red-100 text-red-800' };
                case 'terminated':
                    return { text: 'ƒê√£ thanh l√Ω', className: 'bg-gray-100 text-gray-800' };
                default:
                    return { text: 'Kh√¥ng x√°c ƒë·ªãnh', className: 'bg-gray-100 text-gray-800' };
            }
        }
        
        function updateContractStats() {
            const contracts = contractsCache;
            const total = contracts.length;
            let active = 0, expiring = 0, expired = 0;
            
            contracts.forEach(contract => {
                const status = getContractStatus(contract);
                switch (status) {
                    case 'active': active++; break;
                    case 'expiring': expiring++; break;
                    case 'expired': expired++; break;
                }
            });
            
            document.getElementById('total-contracts').textContent = total;
            document.getElementById('active-contracts').textContent = active;
            document.getElementById('expiring-contracts').textContent = expiring;
            document.getElementById('expired-contracts').textContent = expired;
        }
        
        function loadFilterOptions() {
            const buildings = getBuildings();
            
            // Load building filter
            filterBuilding.innerHTML = '<option value="">T·∫•t c·∫£ t√≤a nh√†</option>';
            buildings.forEach(building => {
                filterBuilding.innerHTML += `<option value="${building.id}">${building.code}</option>`;
            });
            
            // Only add event listeners once
            if (!filterBuilding.hasEventListener) {
                filterBuilding.addEventListener('change', function() {
                    const selectedBuildingId = this.value;
                    filterRoom.innerHTML = '<option value="">T·∫•t c·∫£ ph√≤ng</option>';
                    
                    if (selectedBuildingId) {
                        const building = buildings.find(b => b.id === selectedBuildingId);
                        if (building && building.rooms) {
                            building.rooms.forEach(room => {
                                filterRoom.innerHTML += `<option value="${room}">${room}</option>`;
                            });
                        }
                    }
                    
                    applyFilters();
                });
                filterBuilding.hasEventListener = true;
            }
            
            // Apply filters when changed
            if (!filterRoom.hasEventListener) {
                filterRoom.addEventListener('change', applyFilters);
                filterRoom.hasEventListener = true;
            }
            
            if (!filterStatus.hasEventListener) {
                filterStatus.addEventListener('change', applyFilters);
                filterStatus.hasEventListener = true;
            }
        }
        
        function applyFilters() {
            const buildingFilter = filterBuilding.value;
            const roomFilter = filterRoom.value;
            const statusFilter = filterStatus.value;
            
            let filteredContracts = contractsCache;
            
            if (buildingFilter) {
                filteredContracts = filteredContracts.filter(contract => contract.buildingId === buildingFilter);
            }
            
            if (roomFilter) {
                filteredContracts = filteredContracts.filter(contract => contract.room === roomFilter);
            }
            
            if (statusFilter) {
                filteredContracts = filteredContracts.filter(contract => getContractStatus(contract) === statusFilter);
            }
            
            renderContracts(filteredContracts);
        }
        
        function renderContracts(contracts) {
            const listEl = document.getElementById('contracts-list');
            listEl.innerHTML = '';
            
            if (contracts.length === 0) {
                listEl.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-gray-500">Kh√¥ng t√¨m th·∫•y h·ª£p ƒë·ªìng n√†o.</td></tr>';
                return;
            }
            
            const buildings = getBuildings();
            const customers = getCustomers();
            
            contracts.forEach(contract => {
                const building = buildings.find(b => b.id === contract.buildingId);
                const customer = customers.find(c => c.id === contract.representativeId);
                const status = getContractStatus(contract);
                const statusInfo = getStatusInfo(status);
                const contractNumber = `CT${contract.id.slice(-6).toUpperCase()}`;
                
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="py-4 px-4 font-medium text-blue-600">${contractNumber}</td>
                    <td class="py-4 px-4">
                        <div>
                            <div class="font-medium">${customer ? customer.name : 'N/A'}</div>
                            <div class="text-sm text-gray-500">${building ? building.code : 'N/A'} - ${contract.room}</div>
                        </div>
                    </td>
                    <td class="py-4 px-4">${formatDateDisplay(contract.startDate)}</td>
                    <td class="py-4 px-4">${formatDateDisplay(contract.endDate)}</td>
                    <td class="py-4 px-4">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${statusInfo.className}">
                            ${statusInfo.text}
                        </span>
                    </td>
                    <td class="py-4 px-4">${new Intl.NumberFormat('vi-VN').format(contract.rentPrice)} VNƒê</td>
                    <td class="py-4 px-4">
                        <div class="flex gap-2">
                            <button data-id="${contract.id}" class="edit-contract-btn text-sm font-medium text-blue-600 hover:underline">S·ª≠a</button>
                            ${status !== 'terminated' ? `<button data-id="${contract.id}" class="terminate-contract-btn text-sm font-medium text-red-600 hover:underline">Thanh l√Ω</button>` : ''}
                            <button data-id="${contract.id}" class="delete-contract-btn text-sm font-medium text-gray-600 hover:underline">X√≥a</button>
                        </div>
                    </td>
                `;
                listEl.appendChild(tr);
            });
        }

        function loadBuildingDropdown() {
            const buildings = getBuildings();
            const selectEl = document.getElementById('contract-building');
            selectEl.innerHTML = '<option value="">-- Ch·ªçn t√≤a nh√† --</option>';
            
            buildings.forEach(building => {
                selectEl.innerHTML += `<option value="${building.id}">${building.code}</option>`;
            });
        }

        function loadRoomDropdown(buildingId) {
            const buildings = getBuildings();
            const building = buildings.find(b => b.id === buildingId);
            const selectEl = document.getElementById('contract-room');
            selectEl.innerHTML = '<option value="">-- Ch·ªçn ph√≤ng --</option>';
            
            if (building) {
                building.rooms.forEach(room => {
                    selectEl.innerHTML += `<option value="${room}">${room}</option>`;
                });
            }
        }

        let selectedCustomers = [];
        
        function loadCustomerOptions(searchTerm = '') {
            const customers = getCustomers();
            const container = document.getElementById('customer-options');
            
            if (customers.length === 0) {
                container.innerHTML = '<div class="p-3 text-gray-500 text-sm text-center">Ch∆∞a c√≥ kh√°ch h√†ng n√†o.</div>';
                return;
            }
            
            const filteredCustomers = customers.filter(customer => 
                customer.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                customer.phone.includes(searchTerm)
            );
            
            if (filteredCustomers.length === 0) {
                container.innerHTML = '<div class="p-3 text-gray-500 text-sm text-center">Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng.</div>';
                return;
            }
            
            container.innerHTML = filteredCustomers.map(customer => `
                <label class="flex items-center gap-3 p-3 hover:bg-gray-50 cursor-pointer border-b">
                    <input type="checkbox" value="${customer.id}" class="customer-option-checkbox" ${selectedCustomers.includes(customer.id) ? 'checked' : ''}>
                    <div class="flex-1">
                        <div class="font-medium">${customer.name}</div>
                        <div class="text-gray-500 text-sm">${customer.phone}</div>
                    </div>
                    <label class="flex items-center gap-1 text-sm">
                        <input type="radio" name="representative" value="${customer.id}" class="representative-radio" ${selectedCustomers.includes(customer.id) ? '' : 'disabled'}>
                        ƒê·∫°i di·ªán
                    </label>
                </label>
            `).join('');
        }
        
        function updateSelectedCustomersDisplay() {
            const customers = getCustomers();
            const container = document.getElementById('selected-customers-display');
            const textEl = document.getElementById('selected-customers-text');
            
            if (selectedCustomers.length === 0) {
                textEl.textContent = 'Ch·ªçn kh√°ch h√†ng...';
                container.innerHTML = '';
                return;
            }
            
            textEl.textContent = `ƒê√£ ch·ªçn ${selectedCustomers.length} kh√°ch h√†ng`;
            
            // Display selected customers
            const selectedCustomerData = customers.filter(c => selectedCustomers.includes(c.id));
            container.innerHTML = selectedCustomerData.map(customer => `
                <div class="flex items-center justify-between p-2 bg-blue-50 rounded">
                    <div>
                        <span class="font-medium">${customer.name}</span>
                        <span class="text-gray-500 text-sm ml-2">${customer.phone}</span>
                    </div>
                    <button type="button" class="text-red-500 hover:text-red-700" onclick="removeCustomer('${customer.id}')">‚úï</button>
                </div>
            `).join('');
        }
        
        function removeCustomer(customerId) {
            selectedCustomers = selectedCustomers.filter(id => id !== customerId);
            updateSelectedCustomersDisplay();
            loadCustomerOptions(document.getElementById('customer-search').value);
        }

        function loadServicesList(buildingId) {
            const services = getServices();
            const container = document.getElementById('contract-services-list');
            
            const buildingServices = services.filter(service => 
                service.buildings && service.buildings.includes(buildingId)
            );
            
            if (buildingServices.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Kh√¥ng c√≥ ph√≠ d·ªãch v·ª• n√†o cho t√≤a nh√† n√†y.</p>';
                return;
            }
            
            container.innerHTML = buildingServices.map(service => {
                const isElectric = service.name.toLowerCase().includes('ƒëi·ªán');
                return `
                    <div class="p-3 border rounded">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex-1">
                                <span class="font-medium">${service.name}</span>
                                <span class="text-gray-500 text-sm ml-2">${new Intl.NumberFormat('vi-VN').format(service.price)} VNƒê/${service.unit}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-sm">${isElectric ? 'S·ªë ƒëi·ªán ban ƒë·∫ßu:' : 'S·ªë l∆∞·ª£ng:'}</label>
                                <input type="number" data-service-id="${service.id}" class="${isElectric ? 'electric-initial-reading' : 'service-quantity'} w-20 p-1 border rounded text-center" min="0" value="${isElectric ? '0' : '1'}">
                            </div>
                        </div>
                        ${isElectric ? '<div class="text-xs text-gray-500">S·ªë ƒëi·ªán ban ƒë·∫ßu s·∫Ω ƒë∆∞·ª£c d√πng ƒë·ªÉ t√≠nh H√≥a ƒë∆°n ti·ªÅn ƒëi·ªán</div>' : ''}
                    </div>
                `;
            }).join('');
        }

        // --- DROPDOWN MENU ---
        document.addEventListener('click', (e) => {
            if (e.target.closest('.dropdown-toggle')) {
                const dropdown = e.target.closest('.dropdown-menu');
                const content = dropdown.querySelector('.dropdown-content');
                const arrow = dropdown.querySelector('.dropdown-arrow');
                
                // Close other dropdowns
                document.querySelectorAll('.dropdown-content').forEach(dc => {
                    if (dc !== content) {
                        dc.classList.remove('show');
                    }
                });
                document.querySelectorAll('.dropdown-arrow').forEach(da => {
                    if (da !== arrow) {
                        da.classList.remove('rotated');
                    }
                });
                
                // Toggle current dropdown
                content.classList.toggle('show');
                arrow.classList.toggle('rotated');
            }
        });

        // --- EVENT HANDLERS ---
        buildingsBtn.addEventListener('click', (e) => {
            e.preventDefault();
            showSection('buildings');
        });

        servicesBtn.addEventListener('click', (e) => {
            e.preventDefault();
            showSection('services');
        });

        customersBtn.addEventListener('click', (e) => {
            e.preventDefault();
            showSection('customers');
        });

        contractsBtn.addEventListener('click', (e) => {
            e.preventDefault();
            showSection('contracts');
        });

        billsBtn.addEventListener('click', (e) => {
            e.preventDefault();
            showSection('bills');
        });

        addBuildingBtn.addEventListener('click', () => {
            buildingModalTitle.textContent = 'Th√™m T√≤a nh√†';
            buildingForm.reset();
            document.getElementById('building-id').value = '';
            openModal(buildingModal);
        });

        closeBuildingModalBtn.addEventListener('click', () => closeModal(buildingModal));
        cancelBuildingBtn.addEventListener('click', () => closeModal(buildingModal));

        buildingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('building-id').value;
            const code = document.getElementById('building-code').value.trim();
            const address = document.getElementById('building-address').value.trim();
            const roomsText = document.getElementById('building-rooms').value.trim();
            const rooms = roomsText.split(',').map(room => room.trim()).filter(room => room);

            if (!code || !address || rooms.length === 0) {
                alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!');
                return;
            }

            try {
                const buildingData = {
                    code,
                    address,
                    rooms,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                };

                if (id) {
                    // Edit existing building
                    await setDoc(doc(db, 'buildings', id), buildingData);
                    showToast('C·∫≠p nh·∫≠t t√≤a nh√† th√†nh c√¥ng!');
                } else {
                    // Add new building
                    await addDoc(collection(db, 'buildings'), buildingData);
                    showToast('Th√™m t√≤a nh√† th√†nh c√¥ng!');
                }

                closeModal(buildingModal);
            } catch (error) {
                console.error('Error saving building:', error);
                showToast('L·ªói l∆∞u t√≤a nh√†: ' + error.message, 'error');
            }
        });

        document.getElementById('buildings-list').addEventListener('click', async (e) => {
            const id = e.target.dataset.id;
            
            if (e.target.classList.contains('edit-building-btn')) {
                const building = buildingsCache.find(b => b.id === id);
                if (building) {
                    buildingModalTitle.textContent = 'S·ª≠a T√≤a nh√†';
                    document.getElementById('building-id').value = building.id;
                    document.getElementById('building-code').value = building.code || '';
                    document.getElementById('building-address').value = building.address;
                    document.getElementById('building-rooms').value = building.rooms.join(', ');
                    openModal(buildingModal);
                }
            } else if (e.target.classList.contains('delete-building-btn')) {
                if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t√≤a nh√† n√†y?')) {
                    try {
                        await deleteDoc(doc(db, 'buildings', id));
                        showToast('X√≥a t√≤a nh√† th√†nh c√¥ng!');
                    } catch (error) {
                        console.error('Error deleting building:', error);
                        showToast('L·ªói x√≥a t√≤a nh√†: ' + error.message, 'error');
                    }
                }
            }
        });

        addServiceBtn.addEventListener('click', () => {
            serviceModalTitle.textContent = 'Th√™m Ph√≠ d·ªãch v·ª•';
            serviceForm.reset();
            document.getElementById('service-id').value = '';
            loadBuildingCheckboxes();
            openModal(serviceModal);
        });

        function loadBuildingCheckboxes(selectedBuildings = []) {
            const buildings = getBuildings();
            const container = document.getElementById('building-checkboxes');
            
            if (buildings.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Ch∆∞a c√≥ t√≤a nh√† n√†o. Vui l√≤ng th√™m t√≤a nh√† tr∆∞·ªõc.</p>';
                return;
            }
            
            container.innerHTML = buildings.map(building => `
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" value="${building.id}" ${selectedBuildings.includes(building.id) ? 'checked' : ''} 
                           class="building-checkbox rounded">
                    <span class="text-sm font-medium text-blue-600">${building.code || 'N/A'}</span>
                    <span class="text-sm text-gray-600">- ${building.address}</span>
                </label>
            `).join('');
        }

        closeServiceModalBtn.addEventListener('click', () => closeModal(serviceModal));
        cancelServiceBtn.addEventListener('click', () => closeModal(serviceModal));

        serviceForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('service-id').value;
            const name = document.getElementById('service-name').value.trim();
            const price = parseFormattedNumber(document.getElementById('service-price').value);
            const unit = document.getElementById('service-unit').value.trim();
            
            // Get selected buildings
            const selectedBuildings = Array.from(document.querySelectorAll('.building-checkbox:checked'))
                .map(cb => cb.value);

            if (!name || !price || !unit) {
                alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!');
                return;
            }

            if (selectedBuildings.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt t√≤a nh√†!');
                return;
            }

            try {
                const serviceData = {
                    name,
                    price,
                    unit,
                    buildings: selectedBuildings,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                };

                if (id) {
                    // Edit existing service
                    await setDoc(doc(db, 'services', id), serviceData);
                    showToast('C·∫≠p nh·∫≠t d·ªãch v·ª• th√†nh c√¥ng!');
                } else {
                    // Add new service
                    await addDoc(collection(db, 'services'), serviceData);
                    showToast('Th√™m d·ªãch v·ª• th√†nh c√¥ng!');
                }

                closeModal(serviceModal);
            } catch (error) {
                console.error('Error saving service:', error);
                showToast('L·ªói l∆∞u d·ªãch v·ª•: ' + error.message, 'error');
            }
        });

        document.getElementById('services-list').addEventListener('click', async (e) => {
            const id = e.target.dataset.id;
            
            if (e.target.classList.contains('edit-service-btn')) {
                const service = servicesCache.find(s => s.id === id);
                if (service) {
                    serviceModalTitle.textContent = 'S·ª≠a Ph√≠ d·ªãch v·ª•';
                    document.getElementById('service-id').value = service.id;
                    document.getElementById('service-name').value = service.name;
                    document.getElementById('service-price').value = formatNumber(service.price);
                    document.getElementById('service-unit').value = service.unit;
                    loadBuildingCheckboxes(service.buildings || []);
                    openModal(serviceModal);
                }
            } else if (e.target.classList.contains('delete-service-btn')) {
                if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ph√≠ d·ªãch v·ª• n√†y?')) {
                    try {
                        await deleteDoc(doc(db, 'services', id));
                        showToast('X√≥a d·ªãch v·ª• th√†nh c√¥ng!');
                    } catch (error) {
                        console.error('Error deleting service:', error);
                        showToast('L·ªói x√≥a d·ªãch v·ª•: ' + error.message, 'error');
                    }
                }
            }
        });

        addCustomerBtn.addEventListener('click', () => {
            customerModalTitle.textContent = 'Th√™m Kh√°ch h√†ng';
            customerForm.reset();
            document.getElementById('customer-id').value = '';
            openModal(customerModal);
        });

        closeCustomerModalBtn.addEventListener('click', () => closeModal(customerModal));
        cancelCustomerBtn.addEventListener('click', () => closeModal(customerModal));

        customerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('customer-id').value;
            const name = document.getElementById('customer-name').value.trim();
            const phone = document.getElementById('customer-phone').value.trim();

            if (!name || !phone) {
                alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!');
                return;
            }

            try {
                const customerData = {
                    name,
                    phone,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                };

                if (id) {
                    // Edit existing customer
                    await setDoc(doc(db, 'customers', id), customerData);
                    showToast('C·∫≠p nh·∫≠t kh√°ch h√†ng th√†nh c√¥ng!');
                } else {
                    // Add new customer
                    await addDoc(collection(db, 'customers'), customerData);
                    showToast('Th√™m kh√°ch h√†ng th√†nh c√¥ng!');
                }

                closeModal(customerModal);
            } catch (error) {
                console.error('Error saving customer:', error);
                showToast('L·ªói l∆∞u kh√°ch h√†ng: ' + error.message, 'error');
            }
        });

        document.getElementById('customers-list').addEventListener('click', async (e) => {
            const id = e.target.dataset.id;
            
            if (e.target.classList.contains('edit-customer-btn')) {
                const customer = customersCache.find(c => c.id === id);
                if (customer) {
                    customerModalTitle.textContent = 'S·ª≠a Kh√°ch h√†ng';
                    document.getElementById('customer-id').value = customer.id;
                    document.getElementById('customer-name').value = customer.name;
                    document.getElementById('customer-phone').value = customer.phone;
                    openModal(customerModal);
                }
            } else if (e.target.classList.contains('delete-customer-btn')) {
                if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a kh√°ch h√†ng n√†y?')) {
                    try {
                        await deleteDoc(doc(db, 'customers', id));
                        showToast('X√≥a kh√°ch h√†ng th√†nh c√¥ng!');
                    } catch (error) {
                        console.error('Error deleting customer:', error);
                        showToast('L·ªói x√≥a kh√°ch h√†ng: ' + error.message, 'error');
                    }
                }
            }
        });

        addContractBtn.addEventListener('click', () => {
            contractModalTitle.textContent = 'Th√™m H·ª£p ƒë·ªìng thu√™';
            contractForm.reset();
            document.getElementById('contract-id').value = '';
            selectedCustomers = [];
            loadBuildingDropdown();
            loadCustomerOptions();
            updateSelectedCustomersDisplay();
            openModal(contractModal);
        });

        closeContractModalBtn.addEventListener('click', () => closeModal(contractModal));
        cancelContractBtn.addEventListener('click', () => closeModal(contractModal));

        // Building selection change
        document.getElementById('contract-building').addEventListener('change', (e) => {
            const buildingId = e.target.value;
            if (buildingId) {
                loadRoomDropdown(buildingId);
                loadServicesList(buildingId);
            } else {
                document.getElementById('contract-room').innerHTML = '<option value="">-- Ch·ªçn ph√≤ng --</option>';
                document.getElementById('contract-services-list').innerHTML = '';
            }
        });

        // Customer selector events
        document.getElementById('customer-selector-btn').addEventListener('click', () => {
            const dropdown = document.getElementById('customer-dropdown');
            dropdown.classList.toggle('hidden');
        });

        document.getElementById('customer-search').addEventListener('input', (e) => {
            loadCustomerOptions(e.target.value);
        });

        document.addEventListener('change', (e) => {
            if (e.target.classList.contains('customer-option-checkbox')) {
                const customerId = e.target.value;
                const representativeRadio = document.querySelector(`input[name="representative"][value="${customerId}"]`);
                
                if (e.target.checked) {
                    if (!selectedCustomers.includes(customerId)) {
                        selectedCustomers.push(customerId);
                    }
                    representativeRadio.disabled = false;
                } else {
                    selectedCustomers = selectedCustomers.filter(id => id !== customerId);
                    representativeRadio.checked = false;
                    representativeRadio.disabled = true;
                }
                
                updateSelectedCustomersDisplay();
            }
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('customer-dropdown');
            const button = document.getElementById('customer-selector-btn');
            
            if (!dropdown.contains(e.target) && !button.contains(e.target)) {
                dropdown.classList.add('hidden');
            }
        });

        contractForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const buildingId = document.getElementById('contract-building').value;
            const room = document.getElementById('contract-room').value;
            const startDate = document.getElementById('contract-start-date').value;
            const endDate = document.getElementById('contract-end-date').value;
            const paymentDay = parseInt(document.getElementById('contract-payment-day').value);
            const rentPrice = parseFormattedNumber(document.getElementById('contract-rent-price').value);
            const deposit = parseFormattedNumber(document.getElementById('contract-deposit').value);
            
            // Get selected customers and representative
            const representativeId = document.querySelector('input[name="representative"]:checked')?.value;
            
            // Get services with quantities and electric readings
            const services = [];
            
            // Get regular services
            document.querySelectorAll('.service-quantity').forEach(input => {
                const quantity = parseInt(input.value) || 0;
                if (quantity > 0) {
                    services.push({
                        serviceId: input.dataset.serviceId,
                        quantity: quantity,
                        type: 'quantity'
                    });
                }
            });
            
            // Get electric initial readings
            document.querySelectorAll('.electric-initial-reading').forEach(input => {
                const reading = parseInt(input.value) || 0;
                services.push({
                    serviceId: input.dataset.serviceId,
                    initialReading: reading,
                    type: 'electric'
                });
            });

            if (!buildingId || !room || !startDate || !endDate || !paymentDay || !rentPrice || !deposit) {
                alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!');
                return;
            }

            if (selectedCustomers.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt kh√°ch h√†ng!');
                return;
            }

            if (!representativeId) {
                alert('Vui l√≤ng ch·ªçn ng∆∞·ªùi ƒë·∫°i di·ªán h·ª£p ƒë·ªìng!');
                return;
            }

            try {
                const contractData = {
                    buildingId,
                    room,
                    startDate,
                    endDate,
                    paymentDay,
                    rentPrice,
                    deposit,
                    customers: selectedCustomers,
                    representativeId,
                    services,
                    status: 'active',
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                };

                await addDoc(collection(db, 'contracts'), contractData);
                showToast('Th√™m h·ª£p ƒë·ªìng th√†nh c√¥ng!');
                closeModal(contractModal);
            } catch (error) {
                console.error('Error saving contract:', error);
                showToast('L·ªói l∆∞u h·ª£p ƒë·ªìng: ' + error.message, 'error');
            }
        });

        document.getElementById('contracts-list').addEventListener('click', async (e) => {
            const id = e.target.dataset.id;
            
            if (e.target.classList.contains('delete-contract-btn')) {
                if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a h·ª£p ƒë·ªìng n√†y?')) {
                    try {
                        await deleteDoc(doc(db, 'contracts', id));
                        showToast('X√≥a h·ª£p ƒë·ªìng th√†nh c√¥ng!');
                    } catch (error) {
                        console.error('Error deleting contract:', error);
                        showToast('L·ªói x√≥a h·ª£p ƒë·ªìng: ' + error.message, 'error');
                    }
                }
            }
        });

        // --- MONEY INPUT FORMATTING ---
        document.addEventListener('input', (e) => {
            if (e.target.classList.contains('money-input')) {
                formatMoneyInput(e.target);
            }
        });

        // Quick add customer from contract
        addCustomerFromContractBtn.addEventListener('click', () => {
            openModal(quickCustomerModal);
        });

        closeQuickCustomerModalBtn.addEventListener('click', () => closeModal(quickCustomerModal));
        cancelQuickCustomerBtn.addEventListener('click', () => closeModal(quickCustomerModal));

        quickCustomerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('quick-customer-name').value.trim();
            const phone = document.getElementById('quick-customer-phone').value.trim();

            if (!name || !phone) {
                alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!');
                return;
            }

            try {
                // Add to customers database
                const customerData = {
                    name,
                    phone,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                };

                const docRef = await addDoc(collection(db, 'customers'), customerData);
                const newCustomerId = docRef.id;

                // Auto select the new customer
                if (!selectedCustomers.includes(newCustomerId)) {
                    selectedCustomers.push(newCustomerId);
                }

                // Add to cache temporarily (will be updated by listener)
                customersCache.push({ id: newCustomerId, ...customerData });

                // Refresh customer options and display
                loadCustomerOptions(document.getElementById('customer-search').value);
                updateSelectedCustomersDisplay();

                // Clear form and close modal
                quickCustomerForm.reset();
                closeModal(quickCustomerModal);

                // Show success message
                showToast(`ƒê√£ th√™m kh√°ch h√†ng "${name}" v√† t·ª± ƒë·ªông ch·ªçn!`);
            } catch (error) {
                console.error('Error adding quick customer:', error);
                showToast('L·ªói th√™m kh√°ch h√†ng: ' + error.message, 'error');
            }
        });

        // Handle contract termination and editing
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('terminate-contract-btn')) {
                const contractId = e.target.dataset.id;
                if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën thanh l√Ω h·ª£p ƒë·ªìng n√†y?')) {
                    terminateContract(contractId);
                }
            }
            
            if (e.target.classList.contains('edit-contract-btn')) {
                const contractId = e.target.dataset.id;
                editContract(contractId);
            }
        });
        
        async function terminateContract(contractId) {
            try {
                const contractData = {
                    status: 'terminated',
                    terminatedAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                };

                await setDoc(doc(db, 'contracts', contractId), contractData, { merge: true });
                showToast('ƒê√£ thanh l√Ω h·ª£p ƒë·ªìng th√†nh c√¥ng!');
            } catch (error) {
                console.error('Error terminating contract:', error);
                showToast('L·ªói thanh l√Ω h·ª£p ƒë·ªìng: ' + error.message, 'error');
            }
        }
        
        function editContract(contractId) {
            const contracts = getContracts();
            const contract = contracts.find(c => c.id === contractId);
            
            if (contract) {
                // Fill form with contract data
                document.getElementById('contract-id').value = contract.id;
                document.getElementById('contract-building').value = contract.buildingId;
                loadContractRooms(contract.buildingId);
                document.getElementById('contract-room').value = contract.room;
                document.getElementById('contract-start-date').value = contract.startDate;
                document.getElementById('contract-end-date').value = contract.endDate;
                document.getElementById('contract-payment-day').value = contract.paymentDay;
                document.getElementById('contract-rent-price').value = new Intl.NumberFormat('vi-VN').format(contract.rentPrice);
                document.getElementById('contract-deposit').value = new Intl.NumberFormat('vi-VN').format(contract.deposit);
                
                // Set modal title
                contractModalTitle.textContent = "S·ª≠a H·ª£p ƒë·ªìng Thu√™";
                
                // Load and select customers
                loadContractCustomers(contract.buildingId, contract.room);
                setTimeout(() => {
                    // Select customers
                    contract.tenantIds.forEach(tenantId => {
                        const checkbox = document.querySelector(`input[type="checkbox"][value="${tenantId}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                    
                    // Select representative
                    const repRadio = document.querySelector(`input[name="representative"][value="${contract.representativeId}"]`);
                    if (repRadio) repRadio.checked = true;
                }, 500);
                
                openModal(contractModal);
            }
        }

        // --- BILLS MANAGEMENT ---
        
        function loadBills() {
            billsCache = getBills();
            billsCache.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            renderBills(billsCache);
            updateBillStats();
            loadBillFilterOptions();
        }
        
        function renderBills(bills) {
            const listEl = document.getElementById('bills-list');
            listEl.innerHTML = '';
            
            if (bills.length === 0) {
                listEl.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-gray-500">Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n n√†o.</td></tr>';
                return;
            }
            
            const buildings = getBuildings();
            const customers = getCustomers();
            
            bills.forEach(bill => {
                const building = buildings.find(b => b.id === bill.buildingId);
                const customer = customers.find(c => c.id === bill.customerId);
                const billNumber = `INV${bill.id.slice(-6).toUpperCase()}`;
                
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="py-4 px-4">
                        <button data-id="${bill.id}" class="view-bill-detail-btn text-blue-600 hover:underline font-medium">
                            ${billNumber}
                        </button>
                    </td>
                    <td class="py-4 px-4">
                        <div>
                            <div class="font-medium">${customer ? customer.name : 'N/A'}</div>
                            <div class="text-sm text-gray-500">${building ? building.code : 'N/A'} - ${bill.room}</div>
                        </div>
                    </td>
                    <td class="py-4 px-4">Th√°ng ${bill.period}/${new Date(bill.createdAt).getFullYear()}</td>
                    <td class="py-4 px-4">${formatDateDisplay(bill.billDate)}</td>
                    <td class="py-4 px-4">${new Intl.NumberFormat('vi-VN').format(bill.totalAmount)} VNƒê</td>
                    <td class="py-4 px-4">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${bill.status === 'paid' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                            ${bill.status === 'paid' ? 'ƒê√£ thanh to√°n' : 'Ch∆∞a thanh to√°n'}
                        </span>
                    </td>
                    <td class="py-4 px-4">
                        <div class="flex gap-2">
                            <button data-id="${bill.id}" class="toggle-bill-status-btn text-sm font-medium ${bill.status === 'paid' ? 'text-yellow-600' : 'text-green-600'} hover:underline">
                                ${bill.status === 'paid' ? 'Ch∆∞a TT' : 'ƒê√£ TT'}
                            </button>
                            <button data-id="${bill.id}" class="edit-bill-btn text-sm font-medium text-blue-600 hover:underline">S·ª≠a</button>
                            <button data-id="${bill.id}" class="delete-bill-btn text-sm font-medium text-red-600 hover:underline">X√≥a</button>
                        </div>
                    </td>
                `;
                listEl.appendChild(tr);
            });
            
            // Add event listeners for bill detail buttons
            document.querySelectorAll('.view-bill-detail-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const billId = btn.getAttribute('data-id');
                    showBillDetail(billId);
                });
            });
        }
        
        function updateBillStats() {
            const selectedMonth = filterBillMonth.value;
            let filteredBills = billsCache;
            
            // Filter by month if selected
            if (selectedMonth) {
                filteredBills = billsCache.filter(bill => bill.period == selectedMonth);
            }
            
            const totalAmount = filteredBills.reduce((sum, bill) => sum + bill.totalAmount, 0);
            const collectedAmount = filteredBills.filter(bill => bill.status === 'paid').reduce((sum, bill) => sum + bill.totalAmount, 0);
            const pendingAmount = totalAmount - collectedAmount;
            
            document.getElementById('total-bill-amount').textContent = new Intl.NumberFormat('vi-VN').format(totalAmount) + ' VNƒê';
            document.getElementById('collected-amount').textContent = new Intl.NumberFormat('vi-VN').format(collectedAmount) + ' VNƒê';
            document.getElementById('pending-amount').textContent = new Intl.NumberFormat('vi-VN').format(pendingAmount) + ' VNƒê';
        }
        
        function loadBillFilterOptions() {
            const buildings = getBuildings();
            
            // Load building filter
            filterBillBuilding.innerHTML = '<option value="">T·∫•t c·∫£ t√≤a nh√†</option>';
            buildings.forEach(building => {
                filterBillBuilding.innerHTML += `<option value="${building.id}">${building.code}</option>`;
            });
            
            // Only add event listeners once
            if (!filterBillBuilding.hasEventListener) {
                filterBillBuilding.addEventListener('change', function() {
                    const selectedBuildingId = this.value;
                    filterBillRoom.innerHTML = '<option value="">T·∫•t c·∫£ ph√≤ng</option>';
                    
                    if (selectedBuildingId) {
                        const building = buildings.find(b => b.id === selectedBuildingId);
                        if (building && building.rooms) {
                            building.rooms.forEach(room => {
                                filterBillRoom.innerHTML += `<option value="${room}">${room}</option>`;
                            });
                        }
                    }
                    
                    applyBillFilters();
                });
                filterBillBuilding.hasEventListener = true;
            }
            
            if (!filterBillRoom.hasEventListener) {
                filterBillRoom.addEventListener('change', applyBillFilters);
                filterBillRoom.hasEventListener = true;
            }
            
            if (!filterBillMonth.hasEventListener) {
                filterBillMonth.addEventListener('change', function() {
                    applyBillFilters();
                    updateBillStats(); // Update stats when month changes
                });
                filterBillMonth.hasEventListener = true;
            }
            
            if (!filterBillStatus.hasEventListener) {
                filterBillStatus.addEventListener('change', applyBillFilters);
                filterBillStatus.hasEventListener = true;
            }
        }
        
        function applyBillFilters() {
            const buildingFilter = filterBillBuilding.value;
            const roomFilter = filterBillRoom.value;
            const monthFilter = filterBillMonth.value;
            const statusFilter = filterBillStatus.value;
            
            let filteredBills = billsCache;
            
            if (buildingFilter) {
                filteredBills = filteredBills.filter(bill => bill.buildingId === buildingFilter);
            }
            
            if (roomFilter) {
                filteredBills = filteredBills.filter(bill => bill.room === roomFilter);
            }
            
            if (monthFilter) {
                filteredBills = filteredBills.filter(bill => bill.period == monthFilter);
            }
            
            if (statusFilter) {
                filteredBills = filteredBills.filter(bill => bill.status === statusFilter);
            }
            
            renderBills(filteredBills);
        }

        // --- NEW/IMPROVED BILL DETAIL FUNCTION ---
        function showBillDetail(billId) {
            const bill = billsCache.find(b => b.id === billId);
            if (!bill) {
                alert('Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n!');
                return;
            }

            const building = getBuildings().find(b => b.id === bill.buildingId);
            const customer = getCustomers().find(c => c.id === bill.customerId);
            const contract = getContracts().find(c => c.buildingId === bill.buildingId && c.room === bill.room && getContractStatus(c) === 'active');
            
            const setElementText = (id, text) => document.getElementById(id).textContent = text || 'N/A';
            const setElementSrc = (id, src) => document.getElementById(id).src = src || '';
            const formatVND = (num) => new Intl.NumberFormat('vi-VN').format(num) + ' VNƒê';

            setElementText('bill-detail-number', `INV${bill.id.slice(-6).toUpperCase()}`);
            setElementText('bill-detail-date', formatDateDisplay(bill.billDate));
            
            let dueDate = 'N/A';
            if(contract) {
                const billYear = new Date(bill.billDate).getFullYear();
                dueDate = `${String(contract.paymentDay).padStart(2, '0')}/${String(bill.period).padStart(2, '0')}/${billYear}`;
            }
            setElementText('bill-detail-due-date', dueDate);

            setElementText('bill-detail-room', bill.room);
            setElementText('bill-detail-customer-name', customer ? customer.name : 'N/A');
            setElementText('bill-detail-address', building ? building.address : 'N/A');
            
            const billYear = new Date(bill.createdAt).getFullYear();
            setElementText('bill-detail-title', `H√≥a ƒê∆°n Ti·ªÅn Nh√† Th√°ng ${bill.period}/${billYear}`);

            const servicesTableBody = document.getElementById('bill-detail-services-table');
            servicesTableBody.innerHTML = '';
            let itemIndex = 1;

            if (bill.services && Array.isArray(bill.services)) {
                // Sort services: rent -> electric -> water -> other services
                const sortedServices = [...bill.services].sort((a, b) => {
                    const getOrder = (service) => {
                        if (service.type === 'rent' || service.serviceName === 'Ti·ªÅn nh√†') return 1;
                        if (service.type === 'electric' || service.serviceName === 'Ti·ªÅn ƒëi·ªán') return 2;
                        if (service.serviceName === 'Ti·ªÅn n∆∞·ªõc') return 3;
                        return 4; // other services
                    };
                    return getOrder(a) - getOrder(b);
                });

                sortedServices.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'border-b';
                    
                    let content = item.serviceName;
                    let unitPriceDisplay = new Intl.NumberFormat('vi-VN').format(item.unitPrice || 0);
                    let quantityDisplay = item.quantity;
                    
                    if (item.type === 'rent') {
                        quantityDisplay = item.quantityDisplay || '1';
                        // Add date range display for rent
                        if (item.fromDate && item.toDate) {
                            // Format dates from YYYY-MM-DD to DD/MM (short format)
                            const formatDateShort = (dateStr) => {
                                const [year, month, day] = dateStr.split('-');
                                return `${day}/${month}`;
                            };
                            const fromDateShort = formatDateShort(item.fromDate);
                            const toDateShort = formatDateShort(item.toDate);
                            content += `<br><span class="text-xs text-gray-500">(${fromDateShort} ƒë·∫øn ${toDateShort})</span>`;
                        }
                    } else if (item.type === 'electric') {
                        content += `<br><span class="text-xs text-gray-500">(SC: ${item.oldReading} - SM: ${item.newReading})</span>`;
                        quantityDisplay = item.quantity;
                    }

                    row.innerHTML = `
                        <td class="py-2 px-3 border border-gray-800">${itemIndex++}</td>
                        <td class="py-2 px-3 border border-gray-800">${content}</td>
                        <td class="py-2 px-3 text-center border border-gray-800">${unitPriceDisplay}</td>
                        <td class="py-2 px-3 text-center border border-gray-800">${quantityDisplay}</td>
                        <td class="py-2 px-3 text-right font-medium border border-gray-800">${formatVND(item.amount)}</td>
                    `;
                    servicesTableBody.appendChild(row);
                });
            } else {
                // Fallback for very old data structure before 'services' array
                servicesTableBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center">Kh√¥ng c√≥ chi ti·∫øt d·ªãch v·ª•. T·ªïng ti·ªÅn: ${formatVND(bill.totalAmount)}</td></tr>`;
            }
            
            const finalTotal = bill.totalAmount;
            setElementText('bill-detail-subtotal', formatVND(finalTotal));
            setElementText('bill-detail-due-amount', formatVND(finalTotal));
            
            const qrContent = `THANHTOAN PHONG${bill.room} T${bill.period}${new Date(bill.createdAt).getFullYear()}`;
            const qrUrl = `https://img.vietqr.io/image/${YOUR_BANK_ID}-${YOUR_ACCOUNT_NO}-qr_only.jpg?amount=${finalTotal}&addInfo=${encodeURIComponent(qrContent)}`;
            setElementSrc('bill-detail-qr', qrUrl);

            openModal(billDetailModal);
        }

        function loadBillBuildings() {
            const buildings = getBuildings();
            const selectEl = document.getElementById('bill-building');
            selectEl.innerHTML = '<option value="">-- Ch·ªçn t√≤a nh√† --</option>';
            
            buildings.forEach(building => {
                selectEl.innerHTML += `<option value="${building.id}">${building.code}</option>`;
            });
        }

        function loadBillRooms(buildingId) {
            const buildings = getBuildings();
            const building = buildings.find(b => b.id === buildingId);
            const selectEl = document.getElementById('bill-room');
            selectEl.innerHTML = '<option value="">-- Ch·ªçn ph√≤ng --</option>';
            
            if (building && building.rooms) {
                building.rooms.forEach(room => {
                    selectEl.innerHTML += `<option value="${room}">${room}</option>`;
                });
            }
        }

        function loadBillCustomer(buildingId, room) {
            const contract = contractsCache.find(c => 
                c.buildingId === buildingId && 
                c.room === room && 
                getContractStatus(c) === 'active'
            );
            
            const customerInput = document.getElementById('bill-customer');
            const customerIdInput = document.getElementById('bill-customer-id');
            
            if (contract) {
                const customer = customersCache.find(c => c.id === contract.representativeId);
                if (customer) {
                    customerInput.value = customer.name;
                    customerIdInput.value = customer.id;
                    loadBillServices(contract);
                    return;
                }
            }
            
            customerInput.value = '';
            customerIdInput.value = '';
            clearBillServices();
        }

        function loadBillServices(contract) {
            const listEl = document.getElementById('bill-services-list');
            listEl.innerHTML = '';
            
            if (!contract) {
                listEl.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">Kh√¥ng t√¨m th·∫•y h·ª£p ƒë·ªìng</td></tr>';
                return;
            }

            const selectedPeriod = document.getElementById('bill-period').value;
            if (!selectedPeriod) {
                listEl.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">Vui l√≤ng ch·ªçn k·ª≥ thanh to√°n</td></tr>';
                return;
            }
            
            const year = new Date().getFullYear();
            const monthNumber = parseInt(selectedPeriod); // 1-12
            
            // Create dates in local timezone to avoid timezone issues
            const firstDayOfMonth = new Date(year, monthNumber - 1, 1); // month - 1 for 0-based index
            const lastDayOfMonth = new Date(year, monthNumber, 0); // month + 0 gives last day of previous month = last day of current month
            
            // Format as YYYY-MM-DD without timezone conversion
            const formatDateLocal = (date) => {
                const y = date.getFullYear();
                const m = String(date.getMonth() + 1).padStart(2, '0');
                const d = String(date.getDate()).padStart(2, '0');
                return `${y}-${m}-${d}`;
            };
            
            const firstDay = formatDateLocal(firstDayOfMonth);
            const lastDay = formatDateLocal(lastDayOfMonth);
            
            console.log('Period:', selectedPeriod, 'Month:', monthNumber, 'First:', firstDay, 'Last:', lastDay);
            
            // Add rent row first
            const rentRow = document.createElement('tr');
            rentRow.className = 'border-b';
            rentRow.innerHTML = `
                <td class="py-2 px-3 font-medium">Ti·ªÅn nh√†</td>
                <td class="py-2 px-3">${new Intl.NumberFormat('vi-VN').format(contract.rentPrice || 0)} VNƒê/th√°ng</td>
                <td class="py-2 px-3">
                    <input type="date" value="${firstDay}" class="w-28 text-xs p-1 border rounded">
                </td>
                <td class="py-2 px-3">
                    <input type="date" value="${lastDay}" class="w-28 text-xs p-1 border rounded">
                </td>
                <td class="py-2 px-3">${lastDayOfMonth.getDate()} ng√†y</td>
                <td class="py-2 px-3 font-bold text-blue-600 service-total">${new Intl.NumberFormat('vi-VN').format(contract.rentPrice || 0)} VNƒê</td>
            `;
            listEl.appendChild(rentRow);
            
            if (contract.services && contract.services.length > 0) {
                // Sort services: electric -> water -> other services
                const sortedServices = [...contract.services].sort((a, b) => {
                    const serviceA = servicesCache.find(s => s.id === a.serviceId);
                    const serviceB = servicesCache.find(s => s.id === b.serviceId);
                    
                    const getOrder = (service, contractService) => {
                        if (contractService.type === 'electric' || (service && service.name === 'Ti·ªÅn ƒëi·ªán')) return 1;
                        if (service && service.name === 'Ti·ªÅn n∆∞·ªõc') return 2;
                        return 3; // other services
                    };
                    
                    return getOrder(serviceA, a) - getOrder(serviceB, b);
                });

                sortedServices.forEach(contractService => {
                    const service = servicesCache.find(s => s.id === contractService.serviceId);
                    if (service) {
                        const serviceRow = document.createElement('tr');
                        serviceRow.className = 'border-b';
                        
                        if (contractService.type === 'electric') {
                            serviceRow.innerHTML = `
                                <td class="py-2 px-3 font-medium">${service.name}</td>
                                <td class="py-2 px-3">${new Intl.NumberFormat('vi-VN').format(service.price)} VNƒê/${service.unit}</td>
                                <td class="py-2 px-3">
                                    <input type="number" value="${contractService.initialReading || 0}" class="w-20 text-xs p-1 border rounded electric-old-reading" readonly placeholder="S·ªë c≈©">
                                </td>
                                <td class="py-2 px-3">
                                    <input type="number" class="w-20 text-xs p-1 border rounded electric-new-reading" data-service-id="${service.id}" data-price="${service.price}" placeholder="S·ªë m·ªõi">
                                </td>
                                <td class="py-2 px-3 text-gray-400">-</td>
                                <td class="py-2 px-3 font-bold text-blue-600 service-total">0 VNƒê</td>
                            `;
                        } else {
                            serviceRow.innerHTML = `
                                <td class="py-2 px-3 font-medium">${service.name}</td>
                                <td class="py-2 px-3">${new Intl.NumberFormat('vi-VN').format(service.price)} VNƒê/${service.unit}</td>
                                <td class="py-2 px-3">
                                    <input type="date" value="${firstDay}" class="w-28 text-xs p-1 border rounded">
                                </td>
                                <td class="py-2 px-3">
                                    <input type="date" value="${lastDay}" class="w-28 text-xs p-1 border rounded">
                                </td>
                                <td class="py-2 px-3">
                                    <input type="number" value="${contractService.quantity}" class="w-20 text-xs p-1 border rounded service-quantity" data-service-id="${service.id}" data-price="${service.price}">
                                </td>
                                <td class="py-2 px-3 font-bold text-blue-600 service-total">${new Intl.NumberFormat('vi-VN').format(service.price * contractService.quantity)} VNƒê</td>
                            `;
                        }
                        listEl.appendChild(serviceRow);
                    }
                });
            }
            
            // ƒê·∫¢M B·∫¢O T√çNH TO√ÅN ƒê√öNG SAU KHI RENDER XONG
            calculateBillTotal();
        }       
        
        function clearBillServices() {
            document.getElementById('bill-services-list').innerHTML = '';
            document.getElementById('bill-total-amount').textContent = '0 VNƒê';
        }

        function calculateBillTotal() {
            let total = 0;
            document.querySelectorAll('.service-total').forEach(el => {
                const text = el.textContent.replace(/[^\d]/g, '');
                total += parseInt(text) || 0;
            });
            document.getElementById('bill-total-amount').textContent = new Intl.NumberFormat('vi-VN').format(total) + ' VNƒê';
        }

        document.addEventListener('click', async (e) => {
            if (e.target.classList.contains('toggle-bill-status-btn')) {
                const billId = e.target.dataset.id;
                const bill = billsCache.find(b => b.id === billId);
                if (bill) {
                    try {
                        const newStatus = bill.status === 'paid' ? 'unpaid' : 'paid';
                        await setDoc(doc(db, 'bills', billId), {
                            status: newStatus,
                            updatedAt: serverTimestamp()
                        }, { merge: true });
                        showToast(`ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i H√≥a ƒë∆°n!`);
                    } catch (error) {
                        console.error('Error updating bill status:', error);
                        showToast('L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i: ' + error.message, 'error');
                    }
                }
            }
            
            if (e.target.classList.contains('edit-bill-btn')) {
                editBill(e.target.dataset.id);
            }
            
            if (e.target.classList.contains('delete-bill-btn')) {
                if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a h√≥a ƒë∆°n n√†y?')) {
                    deleteBill(e.target.dataset.id);
                }
            }
        });
        
        function editBill(billId) {
            const bill = billsCache.find(b => b.id === billId);
            if (!bill) return;

            billModalTitle.textContent = "S·ª≠a H√≥a ƒë∆°n Ti·ªÅn Nh√†";
            loadBillBuildings();
            document.getElementById('bill-id').value = bill.id;
            document.getElementById('bill-building').value = bill.buildingId;
            loadBillRooms(bill.buildingId);

            setTimeout(() => {
                document.getElementById('bill-room').value = bill.room;
                document.getElementById('bill-period').value = bill.period;
                document.getElementById('bill-date').value = bill.billDate;
                
                const customer = customersCache.find(c => c.id === bill.customerId);
                if (customer) {
                    document.getElementById('bill-customer').value = customer.name;
                    document.getElementById('bill-customer-id').value = customer.id;
                }

                const listEl = document.getElementById('bill-services-list');
                listEl.innerHTML = '';

                if(bill.services && bill.services.length > 0) {
                    bill.services.forEach(item => {
                        const serviceRow = document.createElement('tr');
                        serviceRow.className = 'border-b';
                        
                        if (item.type === 'rent') {
                             serviceRow.innerHTML = `
                                <td class="py-2 px-3 font-medium">${item.serviceName}</td>
                                <td class="py-2 px-3">${new Intl.NumberFormat('vi-VN').format(item.unitPrice || 0)} VNƒê/${item.unit || 'th√°ng'}</td>
                                <td class="py-2 px-3">
                                    <input type="date" value="${item.fromDate}" class="w-28 text-xs p-1 border rounded">
                                </td>
                                <td class="py-2 px-3">
                                    <input type="date" value="${item.toDate}" class="w-28 text-xs p-1 border rounded">
                                </td>
                                <td class="py-2 px-3">${item.quantityDisplay}</td>
                                <td class="py-2 px-3 font-bold text-blue-600 service-total">${new Intl.NumberFormat('vi-VN').format(item.amount)} VNƒê</td>
                            `;
                        } else if (item.type === 'electric') {
                            serviceRow.innerHTML = `
                                <td class="py-2 px-3 font-medium">${item.serviceName}</td>
                                <td class="py-2 px-3">${new Intl.NumberFormat('vi-VN').format(item.unitPrice)} VNƒê/${item.unit}</td>
                                <td class="py-2 px-3">
                                    <input type="number" value="${item.oldReading}" class="w-20 text-xs p-1 border rounded electric-old-reading" readonly>
                                </td>
                                <td class="py-2 px-3">
                                    <input type="number" value="${item.newReading}" class="w-20 text-xs p-1 border rounded electric-new-reading" data-service-id="${item.serviceId}" data-price="${item.unitPrice}">
                                </td>
                                <td class="py-2 px-3 text-gray-400">-</td>
                                <td class="py-2 px-3 font-bold text-blue-600 service-total">${new Intl.NumberFormat('vi-VN').format(item.amount)} VNƒê</td>
                            `;
                        } else if (item.type === 'service') {
                            serviceRow.innerHTML = `
                                <td class="py-2 px-3 font-medium">${item.serviceName}</td>
                                <td class="py-2 px-3">${new Intl.NumberFormat('vi-VN').format(item.unitPrice)} VNƒê/${item.unit}</td>
                                <td class="py-2 px-3">
                                    <input type="date" value="${item.fromDate}" class="w-28 text-xs p-1 border rounded">
                                </td>
                                <td class="py-2 px-3">
                                    <input type="date" value="${item.toDate}" class="w-28 text-xs p-1 border rounded">
                                </td>
                                <td class="py-2 px-3">
                                    <input type="number" value="${item.quantity}" class="w-20 text-xs p-1 border rounded service-quantity" data-service-id="${item.serviceId}" data-price="${item.unitPrice}">
                                </td>
                                <td class="py-2 px-3 font-bold text-blue-600 service-total">${new Intl.NumberFormat('vi-VN').format(item.amount)} VNƒê</td>
                            `;
                        }
                        listEl.appendChild(serviceRow);
                    });
                    calculateBillTotal();
                }
            }, 300);
            openModal(billModal);
        }
        
        async function deleteBill(billId) {
            try {
                await deleteDoc(doc(db, 'bills', billId));
                showToast('ƒê√£ x√≥a h√≥a ƒë∆°n th√†nh c√¥ng!');
            } catch (error) {
                console.error('Error deleting bill:', error);
                showToast('L·ªói x√≥a h√≥a ƒë∆°n: ' + error.message, 'error');
            }
        }

        // --- DATE INPUT HANDLERS ---
        document.addEventListener('click', function(e) {
            if (e.target.type === 'date') {
                // Single click opens calendar
                e.target.showPicker();
            }
        });

        document.addEventListener('dblclick', function(e) {
            if (e.target.type === 'date') {
                // Double click allows manual typing
                e.target.type = 'text';
                e.target.placeholder = 'YYYY-MM-DD';
                e.target.addEventListener('blur', function() {
                    this.type = 'date';
                }, { once: true });
                e.target.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        this.type = 'date';
                        this.blur();
                    }
                });
            }
        });

        // --- INITIAL LOAD ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Firebase first
            initializeFirebase();
            
            // Show main section by default  
            showSection('bills');
            
            // loadTenants for compatibility
            tenantsCache = customersCache;
        });

    </script>
</body>
</html>
